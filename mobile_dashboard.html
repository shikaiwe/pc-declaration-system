<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ç§»åŠ¨ä»ªè¡¨æ¿</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js' defer></script>
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css">
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <!-- FullCalendar æœ€æ–°ç‰ˆæœ¬ -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <style>
        /* å…¨å±€æ ·å¼ */
        
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            padding-bottom: 60px;
        }
        
        .header {
            background-color: #2196F3;
            color: white;
            text-align: center;
            padding: 10px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-left: 15px;
            padding-right: 15px;
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.2em;
        }
        
        .user-greeting {
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
            color: rgba(255, 255, 255, 0.95);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }
        
        .user-greeting:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }
        
        #username-display {
            font-weight: 600;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #fff;
            position: relative;
            padding-left: 5px;
        }
        
        #greetingText {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }
        
        .card {
            background-color: white;
            margin: 15px;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.4s ease-in-out, box-shadow 0.4s ease-in-out;
            will-change: transform, box-shadow;
            backface-visibility: hidden;
        }
        
        .card:hover {
            transform: translateY(-10px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }
        
        .card.no-hover:hover {
            transform: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .card.active {
            transform: translateY(-10px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }
        
        .navbar {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: #2196F3;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        
        .navbar a {
            flex: 1;
            color: white;
            text-align: center;
            padding: 14px 0;
            text-decoration: none;
            transition: background-color 0.4s ease-in-out;
        }
        
        .navbar a#info-link {
            background-color: lightgreen;
        }
        
        .navbar a#info-link:hover {
            background-color: darkgreen;
        }
        
        .navbar a#logout {
            background-color: orange;
        }
        
        .navbar a#logout:hover {
            background-color: darkorange;
        }
        
        .submenu {
            visibility: hidden;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            z-index: 1000;
            width: 150px;
        }
        
        .submenu.show {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }
        
        .submenu a {
            display: block;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        .submenu a:hover {
            background-color: rgba(33, 150, 243, 0.1);
            color: #2196F3;
        }
        /* æ¨¡æ€æ¡†æ ·å¼ */
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: none;
            width: 90%;
            max-width: 800px;
            border-radius: 12px;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-20px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .modal.show .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        
        .close-button {
            position: absolute;
            right: 15px;
            top: 10px;
            color: #666;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            padding: 5px;
            line-height: 20px;
            z-index: 1;
        }
        
        .close-button:hover {
            color: #333;
        }
        /* æ ‡ç­¾èœå•æ ·å¼ */
        
        .tab-menu {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .tab-link {
            padding: 12px 24px;
            margin: 0 10px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.4s ease-in-out;
            font-size: 1.1em;
        }
        
        .tab-link.active {
            background-color: #0056b3;
        }
        /* è¡¨å•æ ·å¼ */
        
        .tab-content form {
            max-width: 500px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .tab-content form div {
            width: 100%;
            margin-bottom: 20px;
        }
        
        .tab-content label {
            display: block;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .tab-content input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
        }
        
        .tab-content button {
            padding: 12px 24px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.4s ease-in-out;
            margin-top: 15px;
            font-size: 1em;
        }
        
        .tab-content button:hover {
            background-color: #0056b3;
        }
        /* é€€å‡ºç¡®è®¤æ¨¡æ€æ¡†æ ·å¼ */
        
        .logout-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .logout-modal-content {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            text-align: center;
            width: 85%;
            max-width: 320px;
        }
        
        .logout-modal-content p {
            margin: 0 0 20px 0;
            font-size: 16px;
            color: #333;
            line-height: 1.4;
        }
        
        .logout-modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .logout-modal-buttons button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        #confirmLogout {
            background-color: #ff4d4f;
            color: white;
        }
        
        #confirmLogout:hover {
            background-color: #ff7875;
        }
        
        #cancelLogout {
            background-color: #f0f0f0;
            color: #333;
        }
        
        #cancelLogout:hover {
            background-color: #d9d9d9;
        }
        /* å¤©æ°”å¡ç‰‡æ ·å¼ */
        
        .weather-container {
            padding: 10px;
            border-radius: 8px;
            background: linear-gradient(135deg, #6dd5ed, #2196F3);
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .weather-container p {
            margin: 8px 0;
            font-size: 1em;
            display: flex;
            align-items: center;
            line-height: 1.3;
        }
        
        .weather-location {
            font-size: 1.1em !important;
            font-weight: bold;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 5px;
            margin-bottom: 10px !important;
        }
        
        .weather-temp {
            font-size: 1.5em !important;
            font-weight: bold;
            margin: 10px 0 !important;
        }
        
        .weather-details {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 8px;
            margin-top: 10px;
        }
        
        .weather-update-time {
            margin-top: 8px !important;
            padding-top: 8px !important;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 0.9em !important;
            color: rgba(255, 255, 255, 0.9);
        }
        /* æ—¥æœŸæ—¶é—´é€‰æ‹©å™¨æ ·å¼ */
        
        .datetime-picker {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            will-change: opacity;
        }
        
        .datetime-picker.active {
            display: block;
        }
        
        .picker-container {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            border-radius: 16px 16px 0 0;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.1);
            padding-bottom: env(safe-area-inset-bottom);
            -webkit-transform: translateZ(0);
            will-change: transform;
        }
        
        .datetime-picker.active .picker-container {
            transform: translateY(0);
        }
        
        .picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid rgba(33, 150, 243, 0.1);
            background: rgba(33, 150, 243, 0.05);
        }
        
        .picker-header button {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            min-height: 44px;
            min-width: 44px;
        }
        
        .picker-cancel {
            background-color: #f5f5f5;
            color: #666;
        }
        
        .picker-cancel:hover {
            background-color: #eeeeee;
        }
        
        .picker-confirm {
            background-color: #2196F3;
            color: white;
        }
        
        .picker-confirm:hover {
            background-color: #1976D2;
        }
        
        .picker-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        .picker-content {
            display: flex;
            height: 250px;
            padding: 20px;
            background: #fff;
        }
        /* Swiper ç›¸å…³æ ·å¼ */
        
        .swiper-container {
            flex: 1;
            height: 100%;
            position: relative;
            overflow: hidden;
        }
        
        .swiper-scrollbar {
            width: 4px !important;
            right: 4px !important;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 2px;
        }
        
        .swiper-scrollbar-drag {
            background: rgba(33, 150, 243, 0.5);
            border-radius: 2px;
        }
        
        .date-item,
        .time-item {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            font-size: 16px;
            color: #666;
            transition: all 0.3s ease;
            padding: 0 10px;
            border-radius: 8px;
        }
        
        .swiper-slide {
            transition: all 0.3s ease;
        }
        
        .swiper-slide:hover .date-item,
        .swiper-slide:hover .time-item {
            background: rgba(33, 150, 243, 0.05);
        }
        
        .swiper-slide-active .date-item,
        .swiper-slide-active .time-item {
            color: #2196F3;
            font-weight: bold;
            background: rgba(33, 150, 243, 0.1);
            transform: scale(1.05);
        }
        /* è®¢å•çŠ¶æ€æ ·å¼ */
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status-pending {
            background-color: #ffc107;
            color: #000;
        }
        
        .status-allocated {
            background-color: #28a745;
            color: #fff;
        }
        
        .status-completed {
            background-color: #17a2b8;
            color: #fff;
        }
        
        .status-cancelled {
            background-color: #dc3545;
            color: #fff;
        }
        
        .status-unknown {
            background-color: #6c757d;
            color: #fff;
        }
        /* åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨ */
        
        .loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            margin-top: 10px;
            color: #333;
        }
        
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        /* ç§»åŠ¨ç«¯é€‚é… */
        
        @media screen and (max-width: 480px) {
            .modal-content {
                margin: 2% auto;
                width: 95%;
                padding: 15px;
            }
            .datetime-picker .picker-container {
                width: 95% !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                max-height: calc(100vh - 160px);
            }
            .date-item,
            .time-item {
                font-size: 14px;
                padding: 8px;
            }
            .picker-header button {
                font-size: 14px;
                padding: 8px 12px;
            }
        }
        /* æ·±è‰²æ¨¡å¼æ”¯æŒ */
        
        @media (prefers-color-scheme: dark) {
            .datetime-picker .picker-container {
                background: #333;
            }
            .picker-header {
                background: rgba(33, 150, 243, 0.1);
                border-bottom-color: rgba(255, 255, 255, 0.1);
            }
            .picker-title {
                color: #fff;
            }
            .date-item,
            .time-item {
                color: #bbb;
            }
            .swiper-slide:hover .date-item,
            .swiper-slide:hover .time-item {
                background: rgba(255, 255, 255, 0.05);
            }
            .swiper-slide-active .date-item,
            .swiper-slide-active .time-item {
                background: rgba(33, 150, 243, 0.2);
            }
        }
        /* åŠ¨ç”» */
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* é®ç½©å±‚æ ·å¼ */
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        
        .overlay.show {
            opacity: 1;
            visibility: visible;
        }
        /* æ¶ˆæ¯æç¤ºæ¨¡æ€æ¡†æ ·å¼ */
        
        .message-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        
        .message-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .message-content {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            text-align: center;
            min-width: 280px;
            max-width: 90%;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .message-modal.show .message-content {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        /* è®¢å•è¯¦æƒ…å¡ç‰‡æ ·å¼ */
        
        .detail-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1004;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        
        .detail-overlay.show {
            opacity: 1;
            visibility: visible;
            display: block;
        }
        
        .order-detail-card {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            z-index: 1005;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .order-detail-card.show {
            transform: translateY(0);
        }
        /* ç¦æ­¢æ»šåŠ¨æ—¶çš„æ ·å¼ */
        
        body.modal-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            padding-right: 15px;
            /* é˜²æ­¢æ»šåŠ¨æ¡æ¶ˆå¤±å¯¼è‡´é¡µé¢æŠ–åŠ¨ */
        }
        
        .tab-content textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            color: #333;
            background: #fff;
            transition: all 0.3s ease;
            min-height: 100px;
            resize: none;
            font-family: inherit;
        }
        
        .tab-content textarea:hover {
            border-color: #2196F3;
        }
        
        .tab-content textarea:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        .orders-container {
            padding: 15px;
            max-width: 100%;
            margin: 0 auto;
        }
        
        .order-card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .order-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .order-info p {
            margin: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1em;
            line-height: 1.5;
            color: #333;
        }
        
        .order-info p strong {
            color: #666;
            font-weight: 500;
            min-width: 80px;
        }
        
        .order-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
            margin-left: auto;
        }
        
        .order-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
        }
        
        .complete-order-btn,
        .cancel-order-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .complete-order-btn {
            background-color: #2196F3;
            color: white;
        }
        
        .complete-order-btn:hover {
            background-color: #1976D2;
        }
        
        .cancel-order-btn {
            background-color: #ff4d4f;
            color: white;
        }
        
        .cancel-order-btn:hover {
            background-color: #ff7875;
        }
        
        .no-orders {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .no-orders-icon {
            font-size: 3em;
            margin-bottom: 15px;
            display: block;
        }
        
        .error-message {
            text-align: center;
            padding: 40px 20px;
            color: #ff4d4f;
        }
        
        .error-icon {
            font-size: 3em;
            margin-bottom: 15px;
            display: block;
        }
        
        .retry-button {
            margin-top: 15px;
            padding: 8px 20px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .retry-button:hover {
            background-color: #1976D2;
        }
    </style>
</head>

<body>

    <div class="header">
        <h1>PCå¿—æ„¿è€…æœåŠ¡é˜Ÿ</h1>
        <div class="user-greeting">
            <span id="greetingText"></span>
            <span id="username-display"></span>
        </div>
    </div>

    <div class="card">
        <h2>ä»Šæ—¥å¤©æ°”</h2>
        <div id="weather-info" class="weather-container">
            <!-- å¤©æ°”ä¿¡æ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
        </div>
    </div>

    <div class="card hover" id="order-management">
        <h2>è®¢å•ç®¡ç†</h2>
        <p>æ›´å¤šä¿¡æ¯...</p>
    </div>

    <div class="card" id="schedule-management">
        <h2>æ—¥ç¨‹ç®¡ç†</h2>
        <p>æ‰“å¼€æ—¥å†</p>
    </div>

    <div class="navbar">
        <a href="#info" id="info-link">ä¿¡æ¯ç®¡ç†</a>
        <a href="#logout" id="logout">é€€å‡ºç™»å½•</a>
    </div>
    <div id="submenu" class="submenu">
        <a id="home" href="home.html">è¿”å›é¦–é¡µ</a>
        <a id="account" href="#account">è´¦æˆ·ç®¡ç†</a>
    </div>
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>è´¦æˆ·ç®¡ç†</h2>
            <div class="tab-menu">
                <button class="tab-link active" onclick="openTab(event, 'info')">ä¿¡æ¯ä¿®æ”¹</button>
                <button class="tab-link" onclick="openTab(event, 'password')">ä¿®æ”¹å¯†ç </button>
            </div>
            <div class="tab-content" id="info" style="display: block;">
                <form id="infoForm">
                    <div>
                        <label for="username">ç”¨æˆ·å:</label>
                        <input type="text" id="username" name="username" autocomplete="username">
                    </div>
                    <div>
                        <label for="phone">æ‰‹æœºå·ç :</label>
                        <input type="tel" id="phone" name="phone" autocomplete="tel" pattern="[0-9]{11}" placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·ç ">
                    </div>
                    <div id="formMessage" class="form-message"></div>
                    <button type="submit">ä¿å­˜ä¿®æ”¹</button>
                </form>
            </div>
            <div class="tab-content" id="password" style="display: none;">
                <form id="passwordForm">
                    <div>
                        <label for="current-password">åŸå¯†ç :</label>
                        <input type="password" id="current-password" name="current-password" required>
                    </div>
                    <div>
                        <label for="new-password">æ–°å¯†ç :</label>
                        <input type="password" id="new-password" name="new-password" required>
                    </div>
                    <div>
                        <label for="confirm-password">ç¡®è®¤å¯†ç :</label>
                        <input type="password" id="confirm-password" name="confirm-password" required>
                    </div>
                    <div id="passwordMessage" class="form-message"></div>
                    <button type="submit">ä¿®æ”¹å¯†ç </button>
                </form>
            </div>
        </div>
    </div>
    <div id="logoutModal" class="logout-modal">
        <div class="logout-modal-content">
            <p>ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ</p>
            <div class="logout-modal-buttons">
                <button id="confirmLogout">ç¡®è®¤</button>
                <button id="cancelLogout">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="orderManagementModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>è®¢å•ç®¡ç†</h2>
            <div class="tab-menu">
                <button class="tab-link active" onclick="openOrderTab(event, 'newOrder')">æˆ‘è¦æŠ¥å•</button>
                <button class="tab-link" onclick="openOrderTab(event, 'orderHistory')">å†å²è®¢å•</button>
            </div>
            <div class="tab-content" id="newOrder" style="display: block;">
                <form id="newOrderForm" class="styled-form">
                    <div>
                        <label for="userPhoneNumber">æ‰‹æœºå·ç :</label>
                        <input type="tel" id="userPhoneNumber" name="userPhoneNumber" required pattern="[0-9]{11}" placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·">
                        <button type="button" id="fillPhoneNumberButton" class="fill-button" disabled>ä¸€é”®å¡«å……</button>
                    </div>
                    <div>
                        <label for="address">åœ°å€:</label>
                        <input type="text" id="address" name="address" required placeholder="è¯·è¾“å…¥åœ°å€">
                    </div>
                    <div>
                        <label for="issue">é—®é¢˜:</label>
                        <textarea id="issue" name="issue" required rows="1" style="resize: none; overflow: hidden;"></textarea>
                    </div>
                    <div class="datetime-container">
                        <label for="preferredTime">æœŸæœ›ä¸Šé—¨æ—¶é—´:</label>
                        <input type="text" id="preferredTime" name="preferredTime" placeholder="ç‚¹å‡»é€‰æ‹©ä¸Šé—¨æ—¶é—´" required readonly inputmode="none">
                        <div id="timeWarning" style="display: none;">è¯¥æ—¶é—´éä¸Šé—¨æ®µã€‚ä¸Šé—¨æ—¶æ®µä¸º18:00-21:00</div>
                    </div>
                    <div id="reportOrderMessage" class="form-message" style="display: none;"></div>
                    <button type="submit">æäº¤</button>
                </form>
                <div id="reportOrderInfo">
                    <!-- è¿™é‡Œå°†æ˜¾ç¤ºæŠ¥å•ä¿¡æ¯ -->
                </div>
            </div>
            <div class="tab-content" id="orderHistory" style="display: none;">
                <p>è¿™é‡Œæ˜¯å†å²è®¢å•çš„å†…å®¹ã€‚</p>
                <!-- ä½ å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è®¢å•åˆ—è¡¨æˆ–å…¶ä»–å†…å®¹ -->
            </div>
        </div>
    </div>

    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>æ—¥ç¨‹ç®¡ç†</h2>
            <div id="mobileCalendar" style="max-width: 100%; height: 400px;"></div>
        </div>
    </div>

    <div id="overlay" class="overlay"></div>

    <!-- åœ¨bodyæ ‡ç­¾å†…æ·»åŠ  -->
    <div id="messageModal" class="message-modal">
        <div class="message-content">
            <p id="messageText"></p>
            <button id="messageConfirm">ç¡®å®š</button>
        </div>
    </div>

    <!-- åœ¨ body æ ‡ç­¾æœ«å°¾æ·»åŠ ä¸‹ HTML -->
    <div class="detail-overlay" id="detailOverlay"></div>
    <div class="order-detail-card" id="orderDetailCard">
        <div class="pull-indicator"></div>
        <div class="detail-header">
            <h3>è®¢å•è¯¦æƒ…</h3>
            <button class="close-detail" id="closeDetail">&times;</button>
        </div>
        <div class="detail-content" id="orderDetailContent">
            <!-- å†…å®¹å°†é€šè¿‡ JavaScript åŠ¨å¡«å…… -->
        </div>
    </div>

    <script>
        // URLå’ŒAPIé…ç½®
        const ip = '8.134.178.71';
        const BASE_URL = `https://${ip}/api`;
        const API_URLS = {
            // ç”¨æˆ·ç›¸å…³
            LOGIN: `${BASE_URL}/users/login/`,
            LOGOUT: `${BASE_URL}/dashboard/logout/`,
            GET_USER_INFO: `${BASE_URL}/dashboard/get_user_info/`,

            // è´¦æˆ·ç®¡ç†ç›¸å…³
            SAVE_PHONE: `${BASE_URL}/dashboard/savePhoneNumber/`,
            GET_PHONE: `${BASE_URL}/dashboard/getPhoneNumber/`,
            CHANGE_PASSWORD: `${BASE_URL}/dashboard/renew_password/`,

            // è®¢å•ç›¸å…³
            REPORT: `${BASE_URL}/dashboard/call_report/`,
            GET_HISTORY: `${BASE_URL}/dashboard/user_get_history_report/`,
            ASSIGN_ORDER: `${BASE_URL}/dashboard/assign_order/`,
            GET_REPORT_LIST: `${BASE_URL}/dashboard/worker_get_report_list/`,
            COMPLETE_REPORT: `${BASE_URL}/dashboard/complete_report/`,
            CANCEL_REPORT: `${BASE_URL}/dashboard/cancel_report/`,

            // å¤©æ°”ç›¸å…³
            WEATHER_API_KEY: `${BASE_URL}/dashboard/getWeatherApiKey/`
        };


        // åœ¨ script æ ‡ç­¾çš„å¼€å¤´æ·»åŠ ä»¥ä¸‹å·¥å…·å‡½æ•°å®šä¹‰
        const utils = {
            // åŠ å¯†å‡½æ•°
            encrypt: function(text) {
                return btoa(encodeURIComponent(text));
            },

            // è§£å¯†å‡½æ•°
            decrypt: function(encoded) {
                return decodeURIComponent(atob(encoded));
            },

            // å­˜å‚¨æ•°æ®åˆ° localStorage
            saveData: function(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (error) {
                    console.error(`ä¿å­˜${key}æ•°æ®å¤±è´¥:`, error);
                }
            },

            // ä» localStorage è·å–æ•°æ®
            getData: function(key) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error(`è·å–${key}æ•°æ®å¤±è´¥:`, error);
                    return null;
                }
            },

            // ä» localStorage åˆ é™¤æ•°æ®
            removeData: function(key) {
                try {
                    localStorage.removeItem(key);
                } catch (error) {
                    console.error(`åˆ é™¤${key}æ•°æ®å¤±è´¥:`, error);
                }
            }
        };

        // ä¿®æ”¹ API_URLS å¯¹è±¡ï¼Œæ·»åŠ ç¼ºå¤±çš„ URL

        // æ·»åŠ  fetchData å‡½æ•°å®šä¹‰
        async function fetchData(url) {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        }

        // è·å–å¤©æ°”å’Œä½ç½®ä¿¡æ¯
        async function fetchWeatherAndLocation() {
            // ä½¿ç”¨ jQuery è·å– API Key
            function getApiKeyFromServer() {
                return $.ajax({
                    url: API_URLS.WEATHER_API_KEY,
                    method: 'GET',
                    dataType: 'json',
                }).then(data => {
                    if (data.message === 'Success') {
                        return data.apiKey;
                    } else {
                        handleSessionError(data.message);
                    }
                }).catch(error => {
                    console.error('è·å–API Keyæ—¶å‡ºé”™:', error);
                    throw error;
                });
            }
            try {
                const apiKey = await getApiKeyFromServer(); // ä»æœåŠ¡ç«¯è·å–API Key

                const ipData = await fetchData(`https://restapi.amap.com/v3/ip?key=${apiKey}`);
                if (ipData.status !== '1') {
                    throw new Error(`æ— æ³•è·å–IPä¿¡æ¯: ${ipData.info}`);
                }

                const cityAdcode = ipData.adcode; // è·å–åŸå¸‚çš„è¡Œæ”¿åŒºåˆ’ä»£ç 
                const city = ipData.city.replace('å¸‚', ''); // è·å–åŸå¸‚åç§°

                const weatherData = await fetchData(`https://restapi.amap.com/v3/weather/weatherInfo?key=${apiKey}&city=${cityAdcode}&extensions=base&output=JSON`);
                if (weatherData.status !== '1') {
                    throw new Error(`æ— æ³•è·å–å¤©æ°”ä¿¡æ¯: ${weatherData.info}`);
                }

                const live = weatherData.lives[0]; // è·å–å®æ—¶å¤©æ°”ä¿¡æ¯
                const updateTime = new Date().toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                document.getElementById('weather-info').innerHTML = `
                <p class="weather-location">
                    <span class="weather-icon">ğŸ“</span>
                    ${city}
                </p>
                <p class="weather-temp">
                    <span class="weather-icon">ğŸŒ¡ï¸</span>
                    ${live.temperature}Â°C
                </p>
                <div class="weather-details">
                    <p>
                        <span class="weather-icon">ğŸŒ¤ï¸</span>
                        å¤©æ°”ï¼š${live.weather}
                    </p>
                    <p>
                        <span class="weather-icon">ğŸ’§</span>
                        æ¹¿åº¦ï¼š${live.humidity}%
                    </p>
                    <p>
                        <span class="weather-icon">ğŸŒªï¸</span>
                        é£å‘ï¼š${live.winddirection}
                    </p>
                    <p>
                        <span class="weather-icon">ğŸ’¨</span>
                        é£åŠ›ï¼š${live.windpower}çº§
                    </p>
                    <p class="weather-update-time">
                        <span class="weather-icon">ğŸ•’</span>
                        æ›´æ–°æ—¶é—´ï¼š${updateTime}
                    </p>
                </div>
            `; // æ˜¾ç¤ºå¤©æ°”ä¿¡æ¯

            } catch (error) {
                console.error('è·å–å¤©æ°”ä¿¡æ¯æ—¶å‡ºé”™:', error);
                document.getElementById('weather-info').innerHTML = '<p>æ— æ³•è·å–ä¿¡æ¯</p>'; // æ•è·å¹¶æ˜¾ç¤ºè¯·æ±‚é”™è¯¯
            }
        }

        // æ–‡æ¡£åŠ è½½åè·å–å¤©æ°”å’Œä½ç½®ä¿¡æ¯
        document.addEventListener('DOMContentLoaded', (event) => {
            fetchWeatherAndLocation();
        });

        // åˆ‡æ¢å­èœå•æ˜¾ç¤º
        function toggleSubmenu(event) {
            event.stopPropagation();
            const submenu = document.getElementById('submenu');
            submenu.classList.toggle('show');
        }

        // ä¿®æ”¹ä¿¡æ¯ç®¡ç†é“¾æ¥çš„ç‚¹å‡»äº‹ä»¶
        document.getElementById('info-link').addEventListener('click', function(event) {
            event.preventDefault();
            const modal = document.getElementById('editModal');

            modal.style.display = "block";
            document.getElementById('overlay').style.display = "block";
            toggleBodyScroll(true);
        });

        // è®¢å•ç®¡ç†æ¨¡æ€æ¡†
        document.getElementById('order-management').addEventListener('click', function() {
            const modal = document.getElementById('orderManagementModal');
            modal.style.display = "block";
            document.getElementById('overlay').style.display = "block";
            this.classList.add('active');
            toggleBodyScroll(true);

            if (document.getElementById('orderHistory').style.display === 'block') {
                fetchHistoryOrders();
            }
        });

        // æ—¥ç¨‹ç®¡ç†æ¨¡æ€æ¡†
        document.getElementById('schedule-management').addEventListener('click', function() {
            const modal = document.getElementById('scheduleModal');
            modal.style.display = "block";
            document.getElementById('overlay').style.display = "block";
            this.classList.add('active');
            toggleBodyScroll(true);
            // ... å…¶ä½™ä»£ç ä¿æŒä¸å˜ ...
        });

        // é€€å‡ºç¡®è®¤æ€æ¡†
        document.getElementById('logout').addEventListener('click', function(event) {
            event.preventDefault();
            const logoutModal = document.getElementById('logoutModal');
            const overlay = document.getElementById('overlay');
            logoutModal.style.display = 'block';
            overlay.style.display = 'block';
            toggleBodyScroll(true);
        });

        document.getElementById('cancelLogout').addEventListener('click', function() {
            const logoutModal = document.getElementById('logoutModal');
            const overlay = document.getElementById('overlay');
            logoutModal.style.display = 'none';
            overlay.style.display = 'none';
            toggleBodyScroll(false);
        });

        document.getElementById('confirmLogout').addEventListener('click', function() {
            $.ajax({
                url: API_URLS.LOGOUT, // ä½¿ç”¨ API_URLS ä¸­å®šä¹‰çš„ URL
                method: 'GET',
                xhrFields: {
                    withCredentials: true
                }
            }).then(response => {
                if (response.message === 'Success') {
                    utils.removeData('username');
                    utils.removeData('loginData');
                    utils.removeData('rememberMe');
                    window.location.href = 'login.html';
                } else {
                    handleSessionError(response.message);
                }
            }).catch(error => {
                console.error('ç™»å‡ºå¤±è´¥:', error);
                showMessage('ç™»å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        });

        // ä¿®æ”¹æœ‰å…³é—­æ¨¡æ€æ¡†çš„äº‹ä»¶å¤„ç†å™¨
        // ä¿¡æ¯ä¿®æ”¹æ¨¡æ€æ¡†å…³é—­
        document.querySelector('#editModal .close-button').addEventListener('click', function() {
            const modal = document.getElementById('editModal');
            modal.style.display = "none";
            document.getElementById('overlay').style.display = "none";
            toggleBodyScroll(false);
        });

        // è®¢å•ç®¡ç†æ¨¡æ€æ¡†å…³é—­
        document.querySelector('#orderManagementModal .close-button').addEventListener('click', function() {
            const modal = document.getElementById('orderManagementModal');
            modal.style.display = "none";
            document.getElementById('overlay').style.display = "none";
            document.getElementById('order-management').classList.remove('active');
            toggleBodyScroll(false);
        });

        // æ—¥ç¨‹ç®¡ç†æ¨¡æ€æ¡†å…³é—­
        document.querySelector('#scheduleModal .close-button').addEventListener('click', function() {
            const modal = document.getElementById('scheduleModal');
            modal.style.display = "none";
            document.getElementById('overlay').style.display = "none";
            document.getElementById('schedule-management').classList.remove('active');
            toggleBodyScroll(false);
        });

        // åˆ‡æ¢é¡¹å†…å®¹
        function openTab(event, tabName) {
            const tabcontent = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            const tablinks = document.getElementsByClassName("tab-link");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            event.currentTarget.className += " active";
        }

        // ä¿®æ”¹æŠ¥å•æäº¤å¤„ç†
        document.getElementById('newOrderForm').addEventListener('submit', function(event) {
            event.preventDefault();

            // è·å–è¡¨å•æ•°æ®
            const userPhoneNumber = document.getElementById('userPhoneNumber').value;
            const address = document.getElementById('address').value;
            const issue = document.getElementById('issue').value;
            const preferredTimeInput = document.getElementById('preferredTime');
            const preferredTime = preferredTimeInput.dataset.submitValue || preferredTimeInput.value;

            // è¡¨å•éªŒè¯
            if (!userPhoneNumber || !/^1[3-9]\d{9}$/.test(userPhoneNumber)) {
                showMessage('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ');
                return;
            }

            if (!address.trim()) {
                showMessage('è¯·è¾“å…¥åœ°å€');
                return;
            }

            if (!issue.trim()) {
                showMessage('è¯·è¾“å…¥é—®é¢˜æè¿°');
                return;
            }

            if (!preferredTime) {
                showMessage('è¯·é€‰æ‹©é¢„çº¦æ—¶é—´');
                return;
            }

            // æ„é€ è¯·æ±‚æ•°æ®
            const today = new Date();
            const call_date = `${today.getFullYear()}/${String(today.getMonth() + 1).padStart(2, '0')}/${String(today.getDate()).padStart(2, '0')} ${String(today.getHours()).padStart(2, '0')}:${String(today.getMinutes()).padStart(2, '0')}`;

            // è½¬æ¢é¢„çº¦æ—¶é—´æ ¼å¼
            let formattedDate;
            if (preferredTime.includes('å¹´')) {
                // å¦‚æœæ˜¯ä¸­æ–‡æ ¼å¼ï¼Œè½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼
                const match = preferredTime.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥\s*(\d{2}):(\d{2})/);
                if (match) {
                    const [_, year, month, day, hour, minute] = match;
                    formattedDate = `${year}/${String(month).padStart(2, '0')}/${String(day).padStart(2, '0')} ${hour}:${minute}`;
                }
            } else {
                // å¦‚æœæ˜¯æ ‡å‡†æ ¼å¼ï¼Œç¡®ä¿åŒ…å«æ—¶é—´
                const [datePart, timePart] = preferredTime.split(' ');
                formattedDate = `${datePart.replace(/-/g, '/')} ${timePart}`;
            }

            const requestData = {
                userPhoneNumber,
                address,
                issue,
                date: formattedDate,
                call_date,
                status: '0'
            };

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoading(true);

            // å‘é€è¯·æ±‚
            fetch(API_URLS.REPORT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData),
                    credentials: 'include'
                })
                .then(response => response.json())
                .then(data => {
                    showLoading(false);

                    if (data.message === 'Success') {
                        showMessage('æŠ¥å•æäº¤æˆåŠŸ', 'success');
                        // é‡ç½®è¡¨å•
                        document.getElementById('newOrderForm').reset();
                        preferredTimeInput.dataset.submitValue = '';

                        // å¦‚æœåœ¨å†å²è®¢å•é¡µé¢ï¼Œåˆ·æ–°è®¢å•åˆ—è¡¨
                        if (document.getElementById('orderHistory').style.display === 'block') {
                            fetchHistoryOrders();
                        }
                    } else {
                        handleSessionError(data.message);
                    }
                })
                .catch(error => {
                    console.error('æŠ¥å•æäº¤å¤±è´¥:', error);
                    showMessage('æŠ¥å•æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                    showLoading(false);
                });
        });

        // æ·»åŠ åŠ è½½çŠ¶æ€æ§åˆ¶å‡½æ•°
        function showLoading(show) {
            const loadingIndicator = document.querySelector('.loading-indicator');
            if (!loadingIndicator) {
                return;
            }

            if (show) {
                loadingIndicator.style.display = 'flex';
            } else {
                loadingIndicator.style.display = 'none';
            }
        }

        // æ·»åŠ æ˜¾ç¤ºæŠ¥å•æ¶ˆæ¯çš„å‡½æ•°
        function showReportMessage(message, type) {
            const messageElement = document.getElementById('reportOrderMessage');
            messageElement.textContent = message;
            messageElement.className = `form-message ${type}`;
            messageElement.style.display = 'block';

            // å¦‚æœæ˜¯æˆåŠŸæ¶ˆæ¯ï¼Œ3ç§’åè‡ªåŠ¨éšè—
            if (type === 'success') {
                setTimeout(() => {
                    messageElement.style.display = 'none';
                }, 3000);
            }
        }

        // ä¿®æ”¹ formatDate å‡½æ•°
        function formatDate(dateString) {
            try {
                // å¤„ç†å¸¦ç©ºæ ¼çš„æ—¥æœŸæ—¶é—´æ ¼å¼ (YYYY/MM/DD HH:mm æˆ– YYYY-MM-DD HH:mm)
                if (typeof dateString === 'string' && dateString.includes(' ')) {
                    const [datePart, timePart] = dateString.split(' ');
                    const [year, month, day] = datePart.replace(/-/g, '/').split('/');
                    return `${year}å¹´${parseInt(month)}æœˆ${parseInt(day)}æ—¥ ${timePart}`;
                }

                // å¤„ç†ä¸å¸¦æ—¶é—´çš„æ—¥æœŸæ ¼å¼ (YYYY/MM/DD æˆ– YYYY-MM-DD)
                if (typeof dateString === 'string' && (dateString.includes('/') || dateString.includes('-'))) {
                    const [year, month, day] = dateString.replace(/-/g, '/').split('/');
                    return `${year}å¹´${parseInt(month)}æœˆ${parseInt(day)}æ—¥`;
                }

                // å¤„ç†å·²ç»æ˜¯ä¸­æ–‡æ ¼å¼çš„æ—¥æœŸæ—¶é—´
                if (typeof dateString === 'string' && dateString.includes('å¹´') && dateString.includes('æœˆ')) {
                    return dateString;
                }

                // å¤„ç† Date å¯¹è±¡æˆ–å…¶ä»–æ ¼å¼çš„æ—¥æœŸå­—ç¬¦ä¸²
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    throw new Error('æ— æ•ˆçš„æ—¥æœŸæ ¼å¼');
                }

                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');

                return `${year}å¹´${month}æœˆ${day}æ—¥ ${hours}:${minutes}`;
            } catch (error) {
                console.error('æ—¥æœŸæ ¼å¼åŒ–é”™è¯¯:', error, 'åŸå§‹æ—¥æœŸ:', dateString);
                return 'æ—¶é—´æ ¼å¼é”™è¯¯';
            }
        }

        // ä¿®æ”¹ callReportAPI å‡½æ•°
        async function callReportAPI(userPhoneNumber, address, issue, date) {
            const call_date = new Date().toISOString().split('T')[0].replace(/-/g, '/');

            const response = await fetch(API_URLS.REPORT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userPhoneNumber: userPhoneNumber,
                    address: address,
                    issue: issue,
                    date: date.replace(/-/g, '/'), // ç¡®ä¿æ—¥æœŸæ ¼å¼æ­£ç¡®
                    call_date: call_date
                }),
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error('ç½‘ç»œå“åº”å¤±è´¥');
            }

            const data = await response.json();
            if (data.message === 'Success') {
                return data;
            } else {
                handleSessionError(data.message);
                throw new Error(data.message);
            }
        }

        // è·å–CSRF tokençš„å‡½æ•°ï¼ˆå¦‚æœéœ€è¦ï¼‰
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // è‡ªåŠ¨è°ƒæ•´textareaé«˜åº¦
        document.getElementById('issue').addEventListener('input', function() {
            this.style.height = 'auto'; // é‡ç½®é«˜åº¦
            this.style.height = (this.scrollHeight) + 'px'; // è®¾ç½®ä¸ºå†…å®¹é«˜åº¦
        });

        // æ¨¡æ‹Ÿè·å–ç”¨æˆ·ä¿¡æ¯çš„å‡½æ•°
        function getUserInfo() {
            // å‡ä»æœ¬åœ°å­˜å‚¨æˆ–å…¶æ¥æºè·å–ç”¨æˆ·ä¿¡æ¯
            const userInfo = JSON.parse(localStorage.getItem('userInfo')) || {};
            return userInfo;
        }

        // æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯å¹¶è®¾ç½®æŒ‰é’®çŠ¶æ€
        const userPhoneNumberInput = document.getElementById('userPhoneNumber');
        const fillPhoneNumberButton = document.getElementById('fillPhoneNumberButton');

        // ä¿®æ”¹è·å–å’Œå¡«å……æ‰‹æœºå·çš„å‡½æ•°
        function fetchAndFillPhoneNumber() {
            showLoading(true);

            $.ajax({
                url: API_URLS.GET_PHONE,
                method: 'GET',
                xhrFields: {
                    withCredentials: true
                },
                success: function(data) {
                    showLoading(false);
                    if (data.message === 'Success' && data.phoneNumber) {
                        document.getElementById('userPhoneNumber').value = data.phoneNumber;
                    } else if (data.message === 'No phone number') {
                        showMessage('æ‚¨è¿˜æœªè®¾ç½®æ‰‹æœºå·ï¼Œè¯·å…ˆåœ¨è´¦æˆ·ç®¡ç†ä¸­è®¾ç½®');
                    } else {
                        handleSessionError(data.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('è·å–æ‰‹æœºå·å¤±è´¥:', error);
                    showMessage('è·å–æ‰‹æœºå·å¤±è´¥ï¼Œè¯·é‡è¯•');
                    showLoading(false);
                }
            });
        }

        // åœ¨æ–‡æ¡£åŠ è½½å®Œæˆåè®¾ç½®æŒ‰é’®äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing code ...

            // æŒ‰é’®å§‹ç»ˆå¯ç”¨ï¼Œç§»é™¤disabledå±æ€§
            fillPhoneNumberButton.disabled = false;

            // ç»™ä¸€é”®å¡«å……æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
            fillPhoneNumberButton.addEventListener('click', fetchAndFillPhoneNumber);

            // ... existing code ...
        });

        document.addEventListener('DOMContentLoaded', function() {
            const scheduleManagementButton = document.getElementById('schedule-management');
            if (scheduleManagementButton) {
                scheduleManagementButton.addEventListener('click', function() {
                    const modal = document.getElementById('scheduleModal');
                    modal.style.display = "block";
                    document.getElementById('overlay').style.display = "block";
                    this.classList.add('active');

                    // åˆå§‹åŒ–å¹¶æ˜¾ç¤ºæ—¥å†
                    var calendarEl = document.getElementById('mobileCalendar');
                    if (calendarEl) {
                        var calendar = new FullCalendar.Calendar(calendarEl, {
                            initialView: 'dayGridMonth',
                            locale: 'zh-cn',
                            height: 'auto',
                            headerToolbar: {
                                left: 'prev,next today',
                                center: 'title',
                                right: 'dayGridMonth,timeGridWeek,timeGridDay'
                            },
                            views: {
                                timeGridWeek: {
                                    slotMinTime: '18:00:00',
                                    slotMaxTime: '22:00:00',
                                    slotDuration: '00:30:00',
                                    titleFormat: {
                                        year: 'numeric',
                                        month: 'short',
                                        day: '2-digit'
                                    }
                                },
                                timeGridDay: {
                                    slotMinTime: '18:00:00',
                                    slotMaxTime: '22:00:00',
                                    slotDuration: '00:30:00',
                                    titleFormat: {
                                        year: 'numeric',
                                        month: 'short',
                                        day: '2-digit'
                                    }
                                },
                                dayGridMonth: {
                                    titleFormat: {
                                        year: 'numeric',
                                        month: 'short'
                                    }
                                }
                            },
                            slotLabelFormat: {
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: false
                            },
                            buttonText: {
                                today: 'ä»Šå¤©',
                                month: 'æœˆ',
                                week: 'å‘¨',
                                day: 'æ—¥'
                            },
                            dayHeaderFormat: {
                                weekday: 'short'
                            },
                            allDayText: 'å…¨å¤©',
                            noEventsText: 'æš‚æ— äº‹ä»¶',
                            eventTimeFormat: {
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: false
                            },
                            events: function(fetchInfo, successCallback, failureCallback) {
                                $.ajax({
                                    url: API_URLS.GET_HISTORY, // ä½¿ç”¨ API_URLS ä¸­å®šä¹‰çš„ URL
                                    method: 'GET',
                                    xhrFields: {
                                        withCredentials: true
                                    }
                                }).then(response => {
                                    if (response.message === 'Success') {
                                        const events = response.report_info.map(order => {
                                            // æ ¹æ®è®¢å•çŠ¶æ€è®¾ç½®ä¸åŒçš„æ˜¾ç¤ºæ ·å¼
                                            let backgroundColor, borderColor, textColor, statusText;
                                            switch (order.status) {
                                                case '0':
                                                    backgroundColor = '#ffc107'; // é»„è‰²
                                                    borderColor = '#ffc107';
                                                    textColor = '#000';
                                                    statusText = 'å¾…æ¥å•';
                                                    break;
                                                case '1':
                                                    backgroundColor = '#28a745'; // ç»¿è‰²
                                                    borderColor = '#28a745';
                                                    textColor = '#fff';
                                                    statusText = 'å·²æ¥å•';
                                                    break;
                                                case '2':
                                                    backgroundColor = '#17a2b8'; // è“è‰²
                                                    borderColor = '#17a2b8';
                                                    textColor = '#fff';
                                                    statusText = 'å·²å®Œæˆ';
                                                    break;
                                                case '3':
                                                    backgroundColor = '#dc3545'; // çº¢è‰²
                                                    borderColor = '#dc3545';
                                                    textColor = '#fff';
                                                    statusText = 'å·²æ’¤å•';
                                                    break;
                                                default:
                                                    backgroundColor = '#6c757d'; // ç°è‰²
                                                    borderColor = '#6c757d';
                                                    textColor = '#fff';
                                                    statusText = 'æœªçŸ¥çŠ¶æ€';
                                            }

                                            return {
                                                title: `${order.issue.substring(0, 8)}...`, // åªæ˜¾ç¤ºé—®é¢˜æè¿°
                                                start: new Date(order.date.replace(/-/g, '/')),
                                                extendedProps: {
                                                    ...order,
                                                    statusText: statusText, // çŠ¶æ€æ–‡æœ¬ä¿å­˜åœ¨æ‰©å±•å±æ€§ä¸­
                                                    backgroundColor: backgroundColor,
                                                    borderColor: borderColor,
                                                    textColor: textColor
                                                },
                                                backgroundColor: backgroundColor,
                                                borderColor: borderColor,
                                                textColor: textColor,
                                                allDay: false,
                                                displayEventTime: true,
                                                eventDisplay: 'block'
                                            };
                                        });
                                        successCallback(events);
                                    } else if (response.message === 'No history report') {
                                        successCallback([]);
                                    } else {
                                        showMessage('è·å–è®¢å•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                                        failureCallback(new Error(response.message));
                                    }
                                }).catch(error => {
                                    console.error('è·å–æ—¥è®¢å•æ•°æ®å¤±è´¥:', error);
                                    showMessage('è·å–è®¢å•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                                    failureCallback(error);
                                });
                            },
                            eventClick: function(info) {
                                const order = info.event.extendedProps;
                                const detailCard = document.getElementById('orderDetailCard');
                                const detailContent = document.getElementById('orderDetailContent');
                                const overlay = document.getElementById('detailOverlay');
                                const closeBtn = document.getElementById('closeDetail');

                                // ä½¿ç”¨åŸå§‹æ—¥æœŸå­—ç¬¦ä¸²æˆ–æ ¼å¼åŒ–æ—¥æœŸ
                                const displayDate = order.originalDate || formatDate(info.event.start);

                                // è®¾ç½®è¯¦æƒ…å†…å®¹ï¼ŒçŠ¶æ€æ˜¾ç¤ºåœ¨çŠ¶æ€æ 
                                detailContent.innerHTML = `
                                    <div class="detail-row">
                                        <span class="detail-label">çŠ¶æ€</span>
                                        <span class="detail-value">
                                            <span class="status-badge" style="
                                                background-color: ${order.backgroundColor};
                                                border-color: ${order.borderColor};
                                                color: ${order.textColor};">
                                                ${order.statusText}
                                            </span>
                                        </span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">é—®é¢˜æè¿°</span>
                                        <span class="detail-value">${order.issue}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">é¢„çº¦æ—¶é—´</span>
                                        <span class="detail-value">${displayDate}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">åœ°å€</span>
                                        <span class="detail-value">${order.address}</span>
                                    </div>
                                    <div class="detail-row">
                                        <span class="detail-label">è”ç³»ç”µè¯</span>
                                        <span class="detail-value">${order.userPhoneNumber}</span>
                                    </div>
                                `;

                                detailCard.classList.add('show');
                                overlay.classList.add('show');

                                closeBtn.onclick = closeDetail;
                                overlay.onclick = closeDetail;
                            },
                            eventDidMount: function(info) {
                                // ä½¿ç”¨ç§»åŠ¨ç«¯å‹å¥½çš„è§¦æ‘¸æç¤º
                                info.el.addEventListener('click', function() {
                                    showOrderDetail(info.event.extendedProps);
                                });
                            }
                        });
                        calendar.render();
                    }
                });
            }

            // å…³é—­æ—¥ç¨‹ç®¡ç†æ¨¡æ€æ¡†
            document.querySelector('#scheduleModal .close-button').addEventListener('click', function() {
                const modal = document.getElementById('scheduleModal');
                modal.style.display = "none";
                document.getElementById('overlay').style.display = "none"; // éšè—é®ç½©å±‚
                document.getElementById('schedule-management').classList.remove('active'); // ç§»é™¤æµ®èµ·æ ·å¼
            });

            // æ—¥æœŸé€‰æ‹©å™¨åˆå§‹åŒ–
            const preferredTimeInput = document.getElementById('preferredTime');
            if (preferredTimeInput) {
                // ç”Ÿæˆæ—¥æœŸé€‰é¡¹
                function generateDateSlides() {
                    const dates = [];
                    const today = new Date();
                    for (let i = 0; i < 14; i++) {
                        const date = new Date(today);
                        date.setDate(today.getDate() + i);
                        dates.push(`
                        <div class="swiper-slide">
                            <div class="date-item">
                                ${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥
                            </div>
                        </div>
                    `);
                    }
                    return dates.join('');
                }

                // ç”Ÿæˆæ—¶é—´é€‰é¡¹ï¼ˆ18:00-21:00ï¼Œæ¯30åˆ†é’Ÿï¼‰
                function generateTimeSlides() {
                    const times = [];
                    // ä»18:00å¼€å§‹ï¼Œåˆ°21:00ç»“æŸï¼Œæ¯éš”5åˆ†é’Ÿç”Ÿæˆä¸€ä¸ªé€‰é¡¹
                    for (let hour = 18; hour <= 21; hour++) {
                        for (let minute = 0; minute < 60; minute += 5) {
                            // å¦‚æœæ˜¯21ç‚¹ï¼Œåˆ™åªç”Ÿæˆ21:00è¿™ä¸€ä¸ªé€‰é¡¹
                            if (hour === 21 && minute > 0) break;

                            times.push(`
                            <div class="swiper-slide">
                                <div class="time-item">
                                    ${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}
                                </div>
                            </div>
                        `);
                        }
                    }
                    return times.join('');
                }

                // åˆ›å»ºæ—¥æœŸé€‰æ‹©å™¨çš„ HTML ç»“æ„
                const pickerContainer = document.createElement('div');
                pickerContainer.className = 'datetime-picker';
                pickerContainer.innerHTML = `
                <div class="picker-container">
                    <div class="picker-header">
                        <button class="picker-cancel">å–æ¶ˆ</button>
                        <div class="picker-title">é€‰æ‹©æ—¶é—´</div>
                        <button class="picker-confirm">ç¡®å®š</button>
                    </div>
                    <div class="picker-content">
                        <div class="swiper-container date-swiper">
                            <div class="swiper-wrapper">
                                ${generateDateSlides()}
                            </div>
                            <div class="swiper-scrollbar"></div>
                        </div>
                        <div class="swiper-container time-swiper">
                            <div class="swiper-wrapper">
                                ${generateTimeSlides()}
                            </div>
                            <div class="swiper-scrollbar"></div>
                        </div>
                    </div>
                </div>
            `;
                document.body.appendChild(pickerContainer);

                // åˆå§‹åŒ– Swiper
                let dateSwiper, timeSwiper;

                // åˆå§‹åŒ– Swiper æ—¶æ·»åŠ è§¦æ‘¸ä¼˜åŒ–
                setTimeout(() => {
                    dateSwiper = new Swiper('.date-swiper', {
                        direction: 'vertical',
                        slidesPerView: 5,
                        centeredSlides: true,
                        spaceBetween: 10,
                        scrollbar: {
                            el: '.date-swiper .swiper-scrollbar',
                        },
                        touchRatio: 1.5,
                        resistance: true,
                        resistanceRatio: 0.85,
                        touchAngle: 45,
                        touchReleaseOnEdges: true,
                    });

                    timeSwiper = new Swiper('.time-swiper', {
                        direction: 'vertical',
                        slidesPerView: 5,
                        centeredSlides: true,
                        spaceBetween: 10,
                        scrollbar: {
                            el: '.time-swiper .swiper-scrollbar',
                        },
                        touchRatio: 1.5,
                        resistance: true,
                        resistanceRatio: 0.85,
                        touchAngle: 45,
                        touchReleaseOnEdges: true,
                    });
                }, 0);

                // äº‹ä»¶å¤„ç†
                preferredTimeInput.addEventListener('click', function() {
                    pickerContainer.classList.add('active');
                });

                pickerContainer.querySelector('.picker-cancel').addEventListener('click', function() {
                    pickerContainer.classList.remove('active');
                });

                pickerContainer.querySelector('.picker-confirm').addEventListener('click', function(e) {
                    e.preventDefault();

                    if (dateSwiper && timeSwiper) {
                        const selectedDate = dateSwiper.slides[dateSwiper.activeIndex].querySelector('.date-item').textContent.trim();
                        const selectedTime = timeSwiper.slides[timeSwiper.activeIndex].querySelector('.time-item').textContent.trim();

                        // éªŒè¯æ—¶é—´æ˜¯å¦åœ¨å…è®¸èŒƒå›´å†…
                        const [hours, minutes] = selectedTime.split(':').map(Number);
                        if (hours < 18 || (hours === 21 && minutes > 0) || hours > 21) {
                            showMessage('è¯·é€‰æ‹©18:00-21:00ä¹‹é—´çš„æ—¶é—´');
                            return;
                        }

                        const year = new Date().getFullYear();
                        const [month, day] = selectedDate.match(/(\d+)æœˆ(\d+)æ—¥/).slice(1);

                        // æ„å»ºä¸¤ç§æ ¼å¼çš„æ—¥æœŸæ—¶é—´å­—ç¬¦ä¸²
                        const displayDateTime = `${year}å¹´${month}æœˆ${day}æ—¥ ${selectedTime}`;
                        const submitDateTime = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')} ${selectedTime}`;

                        const preferredTimeInput = document.getElementById('preferredTime');
                        preferredTimeInput.value = displayDateTime;
                        preferredTimeInput.dataset.submitValue = submitDateTime;

                        hidePicker();
                    }
                });

                // é˜²æ­¢ç‚¹å‡»é€‰æ‹©å™¨å†…å®¹æ—¶å…³é—­
                const pickerContainerElement = pickerContainer.querySelector('.picker-container');
                pickerContainerElement.addEventListener('click', function(e) {
                    e.stopPropagation();
                });

                // ç‚¹å‡»èƒŒæ™¯å…³é—­é€‰æ‹©å™¨
                pickerContainer.addEventListener('click', function(e) {
                    if (e.target === this) {
                        hidePicker();
                    }
                }, {
                    once: false
                });

                // æ·»åŠ é”®ç›˜äº‹ä»¶å¤„ç†
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && pickerContainer.classList.contains('active')) {
                        hidePicker();
                    }
                });

                // ä¿®æ”¹æ‰‹åŠ¿å…³é—­åŠŸèƒ½
                let startY = 0;
                let currentY = 0;
                const pickerContent = pickerContainer.querySelector('.picker-container');

                pickerContent.addEventListener('touchstart', (e) => {
                    startY = e.touches[0].clientY;
                });

                pickerContent.addEventListener('touchmove', (e) => {
                    currentY = e.touches[0].clientY;
                    const deltaY = currentY - startY;

                    if (deltaY > 0) {
                        pickerContent.style.transform = `translateY(${deltaY}px)`;
                    }
                });

                pickerContent.addEventListener('touchend', () => {
                    if (currentY - startY > 100) {
                        hidePicker();
                    } else {
                        resetTouchState();
                    }
                });

                // æ·»åŠ è§¦æ‘¸å–æ¶ˆäº‹ä»¶å¤„ç†
                pickerContent.addEventListener('touchcancel', resetTouchState);

                // åœ¨å‡½æ•°ä½œç”¨åŸŸå†…å®šä¹‰
                function resetTouchState() {
                    startY = 0;
                    currentY = 0;
                    pickerContent.style.transform = '';
                }
            }
        }); // DOMContentLoaded ç»“æŸ

        // ç»Ÿä¸€çš„ä¼šè¯é”™è¯¯å¤„ç†å‡½æ•°
        function handleSessionError(message) {
            switch (message) {
                case 'Session has expired':
                    alert('ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    break;
                case 'Invalid session':
                    alert('æ— æ•ˆä¼šè¯ï¼Œè¯·é‡æ–°ç™»å½•');
                    break;
                case 'No sessionid cookie':
                    alert('æœªæ‰¾åˆ°ä¼šè¯ä¿¡æ¯ï¼Œè¯·é‡æ–°ç™»å½•');
                    break;
                default:
                    alert('å‘ç”ŸæœªçŸ¥é”™è¯¯ï¼Œè¯·é‡æ–°ç™»å½•');
            }
            utils.removeData('username');
            utils.removeData('loginData');
            utils.removeData('rememberMe');
            window.location.href = 'login.html';
        }

        // æ˜¾ç¤ºå†å²è®¢å•
        function displayHistoryOrders(orders) {
            const historyContent = document.getElementById('orderHistory');
            if (!historyContent) {
                console.error('æ‰¾ä¸åˆ°orderHistoryå…ƒç´ ');
                return;
            }

            const ordersHTML = orders.map(order => {
                        // æ ¹æ®çŠ¶æ€è·å–å¯¹åº”çš„æ˜¾ç¤ºæ–‡æœ¬å’Œæ ·å¼
                        let statusText, statusClass;
                        let showCompleteButton = false;
                        let showCancelButton = false; // æ·»åŠ è¿™è¡Œ
                        switch (order.status) {
                            case '0':
                                statusText = 'å¾…åˆ†é…';
                                statusClass = 'status-pending';
                                showCompleteButton = true;
                                showCancelButton = true; // æ·»åŠ è¿™è¡Œ
                                break;
                            case '1':
                                statusText = 'å·²åˆ†é…';
                                statusClass = 'status-allocated';
                                showCompleteButton = true;
                                showCancelButton = true; // æ·»åŠ è¿™è¡Œ
                                break;
                            case '2':
                                statusText = 'å·²å®Œæˆ';
                                statusClass = 'status-completed';
                                break;
                            case '3':
                                statusText = 'å·²æ’¤å•';
                                statusClass = 'status-cancelled';
                                break;
                            default:
                                statusText = 'æœªçŸ¥çŠ¶æ€';
                                statusClass = 'status-unknown';
                        }

                        return `
                <div class="order-card">
                    <div class="order-info">
                        ${order.reportId ? `
                            <p>
                                <strong>è®¢å•ç¼–å·ï¼š</strong>
                                ${order.reportId}
                            </p>
                        ` : ''}
                        <p>
                            <strong>æ‰‹æœºå·ç ï¼š</strong>
                            ${order.userPhoneNumber}
                            <span class="order-status ${statusClass}">
                                ${statusText}
                            </span>
                        </p>
                        <p>
                            <strong>åœ°å€ï¼š</strong>
                            ${order.address}
                        </p>
                        <p>
                            <strong>é—®é¢˜æè¿°ï¼š</strong>
                            ${order.issue}
                        </p>
                        <p>
                            <strong>é¢„çº¦æ—¶é—´ï¼š</strong>
                            ${formatDate(order.date)}
                        </p>
                        <p>
                            <strong>æäº¤æ—¶é—´ï¼š</strong>
                            ${formatDate(order.call_date)}
                        </p>
                        <div class="order-buttons">
                            ${showCompleteButton ? `
                                <button class="complete-order-btn" onclick="completeOrder('${order.reportId}')">
                                    ç»“å•
                                </button>
                            ` : ''}
                            ${showCancelButton ? `
                                <button class="cancel-order-btn" onclick="cancelOrder('${order.reportId}')">
                                    æ’¤å•
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            }).join('');

            historyContent.innerHTML = `
            <div class="orders-container" style="opacity: 1;">
                ${ordersHTML}
            </div>
        `;
        }

        // æ·»åŠ ç»“å•åŠŸèƒ½å‡½æ•°
        async function completeOrder(reportId) {
            try {
                const response = await fetch(API_URLS.COMPLETE_REPORT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reportId }),
                    credentials: 'include'
                });

                const data = await response.json();

                switch (data.message) {
                    case 'Success':
                        showMessage('ç»“å•æˆåŠŸ');
                        // åˆ·æ–°è®¢å•åˆ—è¡¨
                        fetchHistoryOrders();
                        break;
                    case 'This report is completed':
                        showMessage('è¯¥è®¢å•å·²ç»“æŸ');
                        break;
                    case 'This report is no exist':
                        showMessage('è®¢å•ä¸å­˜åœ¨');
                        break;
                    default:
                        handleSessionError(data.message);
                }
            } catch (error) {
                console.error('ç»“å•å¤±è´¥:', error);
                showMessage('ç»“å•å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // æ·»åŠ æ’¤å•åŠŸèƒ½å‡½æ•°
        async function cancelOrder(reportId) {
            try {
                const response = await fetch(API_URLS.CANCEL_REPORT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reportId }),
                    credentials: 'include'
                });

                const data = await response.json();

                switch (data.message) {
                    case 'Success':
                        showMessage('æ’¤å•æˆåŠŸ');
                        // åˆ·æ–°è®¢å•åˆ—è¡¨
                        fetchHistoryOrders();
                        break;
                    default:
                        handleSessionError(data.message);
                }
            } catch (error) {
                console.error('æ’¤å•å¤±è´¥:', error);
                showMessage('æ’¤å•å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // æ˜¾ç¤ºæ— è®¢å•çŠ¶æ€
        function showNoOrders() {
            const historyContent = document.getElementById('orderHistory');
            if (historyContent) {
                historyContent.innerHTML = `
                <div class="no-orders">
                    <i class="no-orders-icon">ğŸ“</i>
                    <p>æš‚æ— å†å²è®¢å•</p>
                </div>
            `;
            }
        }

        // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
        function showError() {
            const historyContent = document.getElementById('orderHistory');
            if (historyContent) {
                historyContent.innerHTML = `
                <div class="error-message">
                    <i class="error-icon">âŒ</i>
                    <p>è·å–å†å²è®¢å•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>
                    <button class="retry-button" onclick="fetchHistoryOrders()">é‡è¯•</button>
                </div>
            `;
            }
        }

        // è·å–å†å²è®¢å•
        async function fetchHistoryOrders() {
            try {
                showLoading(true);

                const response = await fetch(API_URLS.GET_HISTORY, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('è·å–åˆ°çš„å†å²è®¢å•æ•°æ®:', data); // æ·»åŠ è°ƒè¯•æ—¥å¿—

                showLoading(false);

                switch (data.message) {
                    case 'Success':
                        if (data.report_info && Array.isArray(data.report_info)) {
                            if (data.report_info.length > 0) {
                                displayHistoryOrders(data.report_info);
                            } else {
                                showNoOrders();
                            }
                        } else {
                            showNoOrders();
                        }
                        break;

                    case 'No history report':
                        showNoOrders();
                        break;

                    case 'Session has expired':
                    case 'Invalid session':
                    case 'No sessionid cookie':
                        handleSessionError(data.message);
                        break;

                    default:
                        showError();
                        break;
                }
            } catch (error) {
                console.error('è·å–å†å²è®¢å•å¤±è´¥:', error);
                showError();
                showLoading(false);
            }
        }

        // ä¿®æ”¹è´¦å·ä¿¡æ¯è¡¨å•çš„æäº¤å¤„ç†
        document.getElementById('infoForm').addEventListener('submit', async (event) => {
            event.preventDefault();

            const phoneNumber = document.getElementById('phone').value.trim();
            const newName = document.getElementById('username').value.trim();

            // å¦‚æœä¸¤ä¸ªå­—æ®µéƒ½ä¸ºç©ºï¼Œæç¤ºç”¨æˆ·
            if (!phoneNumber && !newName) {
                showMessage('è¯·è‡³å°‘å¡«å†™ä¸€é¡¹éœ€è¦ä¿®æ”¹çš„ä¿¡æ¯');
                return;
            }

            // å¦‚æœå¡«å†™äº†æ‰‹æœºå·ï¼ŒéªŒè¯æ ¼å¼
            if (phoneNumber && !/^1[3-9]\d{9}$/.test(phoneNumber)) {
                showMessage('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç æ ¼å¼');
                return;
            }

            const requestData = {};
            if (phoneNumber) requestData.phoneNumber = phoneNumber;
            if (newName) requestData.newName = newName;

            try {
                const response = await fetch(API_URLS.SAVE_PHONE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData),
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.message === 'Success') {
                    showMessage('ä¿å­˜æˆåŠŸ');
                    if (requestData.newName) {
                        utils.saveData('username', requestData.newName);
                        document.getElementById('username-display').textContent = requestData.newName;
                    }
                    // æ¸…ç©ºè¡¨å•
                    event.target.reset();
                } else if (data.message === 'This user is existed') {
                    showMessage('ç”¨æˆ·åå·²è¢«å ç”¨');
                } else {
                    handleSessionError(data.message);
                }
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                showMessage('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        });

        // æ·»æ˜¾ç¤ºæ¶ˆæ¯çš„å‡½æ•°
        function showMessage(message, type) {
            const messageModal = document.getElementById('messageModal');
            const messageText = document.getElementById('messageText');
            const confirmButton = document.getElementById('messageConfirm');

            messageText.textContent = message;
            messageModal.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => {
                    messageModal.style.display = 'none';
                }, 3000);
            }

            confirmButton.onclick = () => {
                messageModal.style.display = 'none';
            };
        }

        // åœ¨ç°æœ‰çš„ JavaScript ä»£ç ä¸­æ·»åŠ ä»¥ä¸‹å‡½æ•°
        function toggleBodyScroll(disable) {
            if (disable) {
                document.body.classList.add('modal-open');
            } else {
                document.body.classList.remove('modal-open');
            }
        }

        // æ·»åŠ è®¢å•æ ‡ç­¾åˆ‡æ¢å‡½æ•°
        function openOrderTab(event, tabName) {
            const tabcontent = document.querySelectorAll("#orderManagementModal .tab-content");
            tabcontent.forEach(tab => tab.style.display = "none");

            const tablinks = document.querySelectorAll("#orderManagementModal .tab-link");
            tablinks.forEach(link => link.classList.remove("active"));

            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.style.display = "block";
                event.currentTarget.classList.add("active");

                // å¦‚æœåˆ‡æ¢åˆ°å†å²è®¢å•æ ‡ç­¾ï¼Œåˆ™è·å–å†å²è®¢å•æ•°æ®
                if (tabName === 'orderHistory') {
                    fetchHistoryOrders();
                }
            }
        }

        // æ·»åŠ å…³é—­è¯¦æƒ…çš„å‡½æ•°
        function closeDetail() {
            const detailCard = document.getElementById('orderDetailCard');
            const overlay = document.getElementById('detailOverlay');

            detailCard.classList.remove('show');
            overlay.classList.remove('show');

            // é‡ç½®transformæ ·å¼
            detailCard.style.transform = '';
        }

        // æ·»åŠ ä¿®æ”¹å¯†ç è¡¨å•æäº¤å¤„ç†
        document.getElementById('passwordForm').addEventListener('submit', async function (event) {
            event.preventDefault();
            const oldPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (newPassword !== confirmPassword) {
                showMessage('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´');
                return;
            }

            try {
                const response = await fetch(API_URLS.RENEW_PASSWORD, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        old_password: oldPassword,
                        new_password: newPassword
                    }),
                    credentials: 'include'
                });

                const data = await response.json();
                if (data.message === 'Success') {
                    showMessage('å¯†ç ä¿®æ”¹æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•', () => {
                        // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„æ•°æ®
                        localStorage.removeItem('username');
                        localStorage.removeItem('loginData');
                        localStorage.removeItem('rememberMe');

                        // è°ƒç”¨é€€å‡ºç™»å½•APIæ¸…é™¤æœåŠ¡å™¨ç«¯session
                        fetch(API_URLS.LOGOUT, {
                            method: 'GET',
                            credentials: 'include'
                        }).finally(() => {
                            // æ— è®ºé€€å‡ºç™»å½•APIæ˜¯å¦æˆåŠŸï¼Œéƒ½è·³è½¬åˆ°ç™»å½•é¡µ
                            window.location.href = 'login.html';
                        });
                    });
                } else if (data.message === 'Password error') {
                    showMessage('åŸå¯†ç é”™è¯¯');
                } else {
                    handleSessionError(data.message);
                }
            } catch (error) {
                showMessage('å¯†ç ä¿®æ”¹å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        });

        // åœ¨æ–‡æ¡£åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function () {
            // è·å–é—®å€™è¯­å…ƒç´ 
            const greetingText = document.getElementById('greetingText');
            const usernameDisplay = document.getElementById('username-display');

            // æ›´æ–°é—®å€™è¯­å‡½æ•°
            function updateGreeting() {
                const hour = new Date().getHours();
                let greeting = '';

                if (hour >= 5 && hour < 9) {
                    greeting = 'æ—©ä¸Šå¥½ï¼Œ';
                } else if (hour >= 9 && hour < 11) {
                    greeting = 'ä¸Šåˆå¥½ï¼Œ';
                } else if (hour >= 11 && hour < 13) {
                    greeting = 'ä¸­åˆå¥½ï¼Œ';
                } else if (hour >= 13 && hour < 18) {
                    greeting = 'ä¸‹åˆå¥½ï¼Œ';
                } else {
                    greeting = 'æ™šä¸Šå¥½ï¼Œ';
                }

                if (greetingText) {
                    greetingText.textContent = greeting;
                }
            }

            // è·å–å¹¶æ˜¾ç¤ºç”¨æˆ·å
            function displayUsername() {
                const usernameDisplay = document.getElementById('username-display');
                if (!usernameDisplay) return;

                $.ajax({
                    url: API_URLS.GET_USER_INFO,
                    method: 'GET',
                    xhrFields: {
                        withCredentials: true
                    },
                    success: function (data) {
                        if (data.message === 'Success') {
                            const username = data.username;
                            utils.saveData('username', username);
                            usernameDisplay.textContent = username;
                        } else {
                            handleSessionError(data.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                        const username = utils.getData('username');
                        usernameDisplay.textContent = username || 'ç”¨æˆ·';
                    }
                });
            }

            // åˆå§‹åŒ–æ˜¾ç¤º
            updateGreeting();
            displayUsername();

            // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡é—®å€™è¯­
            setInterval(updateGreeting, 60000);
        });

        // åœ¨ç™»å½•æˆåŠŸæ—¶ä¿å­˜ç”¨æˆ·å
        function saveUsername(username) {
            if (username) {
                utils.saveData('username', username);
            }
        }

        // åœ¨é€€å‡ºç™»å½•æ—¶æ¸…é™¤ç”¨æˆ·å
        function clearUsername() {
            utils.removeData('username');
        }

        // åœ¨é€€å‡ºç™»å½•å‡½æ•°ä¸­æ·»åŠ 
        function handleLogout() {
            $.ajax({
                url: API_URLS.LOGOUT,
                method: 'GET',
                xhrFields: {
                    withCredentials: true
                }
            }).then(response => {
                if (response.message === 'Success') {
                    // æ¸…é™¤æ‰€æœ‰å­˜å‚¨çš„æ•°æ®
                    utils.removeData('username');
                    utils.removeData('loginData');
                    utils.removeData('rememberMe');
                    window.location.href = 'login.html';
                } else {
                    handleSessionError(response.message);
                }
            }).catch(error => {
                console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                showMessage('é€€å‡ºç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }

        // ç§»åŠ¨ç«¯ç‰¹æœ‰çš„æ‰‹åŠ¿æ“ä½œåŠŸèƒ½
        function initMobileFeatures() {
            const detailCard = document.getElementById('orderDetailCard');
            let startY = 0;
            let currentY = 0;

            // è§¦æ‘¸å¼€å§‹æ—¶è®°å½•èµ·å§‹ä½ç½®
            detailCard.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
            });

            // è§¦æ‘¸ç§»åŠ¨æ—¶è®¡ç®—ä½ç§»å¹¶åº”ç”¨å˜æ¢
            detailCard.addEventListener('touchmove', (e) => {
                currentY = e.touches[0].clientY;
                const deltaY = currentY - startY;

                if (deltaY > 0) {
                    detailCard.style.transform = `translateY(${deltaY}px)`;
                }
            });

            // è§¦æ‘¸ç»“æŸæ—¶åˆ¤æ–­æ˜¯å¦å…³é—­è¯¦å¡ç‰‡
            detailCard.addEventListener('touchend', () => {
                if (currentY - startY > 100) {
                    closeDetail();
                } else {
                    detailCard.style.transform = '';
                }
            });
        }

        // å§‹åŒ–ç§»åŠ¨ç«¯åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', () => {
            initMobileFeatures();
        });

        // ä¿®æ”¹å¯†ç ä¿®æ”¹å‡½æ•°
        async function changePassword(oldPassword, newPassword) {
            try {
                const response = await fetch(API_URLS.CHANGE_PASSWORD, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        old_password: oldPassword,
                        new_password: newPassword
                    }),
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.message === 'Success') {
                    showMessage('å¯†ç ä¿®æ”¹æˆåŠŸ');
                    document.getElementById('passwordForm').reset();
                } else if (data.message === 'Password error') {
                    showMessage('åŸå¯†ç é”™è¯¯');
                } else {
                    handleSessionError(data.message);
                }
            } catch (error) {
                console.error('å¯†ç ä¿®æ”¹å¤±è´¥:', error);
                showMessage('å¯†ç ä¿®æ”¹å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // æ—¥æœŸæ—¶é—´é€‰æ‹©å™¨ç›¸å…³å‡½æ•°
        function hidePicker() {
            const pickerContainer = document.querySelector('.datetime-picker');
            if (pickerContainer) {
                pickerContainer.classList.remove('active');
                document.body.style.overflow = ''; // æ¢å¤èƒŒæ™¯æ»šåŠ¨

                // é‡ç½®é€‰æ‹©å™¨ä½ç½®
                const pickerContent = pickerContainer.querySelector('.picker-container');
                if (pickerContent) {
                    pickerContent.style.transform = '';
                }
            }
        }

        function initDateTimePicker(preferredTimeInput) {
            // æ˜¾ç¤ºé€‰æ‹©å™¨
            function showPicker() {
                const pickerContainer = document.querySelector('.datetime-picker');
                if (pickerContainer) {
                    pickerContainer.classList.add('active');
                    document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
                }
            }

            // æ·»åŠ è§¦æ‘¸äº‹ä»¶å¤„ç†
            let startY = 0;
            let currentY = 0;
            const pickerContent = document.querySelector('.picker-container');

            if (pickerContent) {
                // è§¦æ‘¸å¼€å§‹
                pickerContent.addEventListener('touchstart', (e) => {
                    startY = e.touches[0].clientY;
                }, { passive: true });

                // è§¦æ‘¸ç§»åŠ¨
                pickerContent.addEventListener('touchmove', (e) => {
                    currentY = e.touches[0].clientY;
                    const deltaY = currentY - startY;

                    if (deltaY > 0) {
                        pickerContent.style.transform = `translateY(${deltaY}px)`;
                    }
                }, { passive: true });

                // è§¦æ‘¸ç»“æŸ
                pickerContent.addEventListener('touchend', () => {
                    if (currentY - startY > 100) {
                        hidePicker();
                    } else {
                        pickerContent.style.transform = '';
                    }
                    startY = 0;
                    currentY = 0;
                });

                // è§¦æ‘¸å–æ¶ˆ
                pickerContent.addEventListener('touchcancel', () => {
                    pickerContent.style.transform = '';
                    startY = 0;
                    currentY = 0;
                });
            }

            // ç‚¹å‡»è¾“å…¥æ¡†æ˜¾ç¤ºé€‰æ‹©å™¨
            preferredTimeInput.addEventListener('touchstart', showPicker, { passive: true });

            // é€‰æ‹©å™¨ç¡®è®¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.querySelector('.picker-confirm').addEventListener('touchstart', function (e) {
                e.preventDefault();

                if (dateSwiper && timeSwiper) {
                    const selectedDate = dateSwiper.slides[dateSwiper.activeIndex].querySelector('.date-item').textContent.trim();
                    const selectedTime = timeSwiper.slides[timeSwiper.activeIndex].querySelector('.time-item').textContent.trim();

                    // éªŒè¯æ—¶é—´æ˜¯å¦åœ¨å…è®¸èŒƒå›´å†…
                    const [hours, minutes] = selectedTime.split(':').map(Number);
                    if (hours < 18 || (hours === 21 && minutes > 0) || hours > 21) {
                        showMessage('è¯·é€‰æ‹©18:00-21:00ä¹‹é—´çš„æ—¶é—´');
                        return;
                    }

                    const year = new Date().getFullYear();
                    const [month, day] = selectedDate.match(/(\d+)æœˆ(\d+)æ—¥/).slice(1);

                    // æ„å»ºä¸¤ç§æ ¼å¼çš„æ—¥æœŸæ—¶é—´å­—ç¬¦ä¸²
                    const displayDateTime = `${year}å¹´${month}æœˆ${day}æ—¥ ${selectedTime}`;
                    const submitDateTime = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')} ${selectedTime}`;

                    preferredTimeInput.value = displayDateTime;
                    preferredTimeInput.dataset.submitValue = submitDateTime;

                    hidePicker();
                }
            });

            // é€‰æ‹©å™¨å–æ¶ˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.querySelector('.picker-cancel').addEventListener('touchstart', function (e) {
                e.preventDefault();
                hidePicker();
            });

            // ç‚¹å‡»èƒŒæ™¯å…³é—­é€‰æ‹©å™¨
            document.querySelector('.datetime-picker').addEventListener('touchstart', function (e) {
                if (e.target === this) {
                    hidePicker();
                }
            }, { passive: true });
        }

        // æ·»åŠ ç»Ÿä¸€çš„é”™è¯¯æç¤ºå‡½æ•°
        function showError(message, type = 'error') {
            const messageElement = document.createElement('div');
            messageElement.className = `alert alert-${type}`;
            messageElement.textContent = message;
            messageElement.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 4px;
            background-color: ${type === 'error' ? '#ff4d4f' : '#52c41a'};
            color: white;
            z-index: 2000;
            animation: slideIn 0.3s ease;
        `;

            document.body.appendChild(messageElement);

            setTimeout(() => {
                messageElement.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => messageElement.remove(), 300);
            }, 3000);
        }

        // æ·»åŠ ç½‘ç»œçŠ¶æ€ç›‘æµ‹
        function initNetworkDetection() {
            function updateNetworkStatus() {
                if (!navigator.onLine) {
                    showMessage('ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®', 'error');
                }
            }

            window.addEventListener('online', () => showMessage('ç½‘ç»œå·²è¿æ¥', 'success'));
            window.addEventListener('offline', updateNetworkStatus);

            // åˆå§‹æ£€æŸ¥
            updateNetworkStatus();
        }

        // åœ¨æ–‡æ¡£åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initNetworkDetection();
        });

        // æ·»åŠ åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨
        function showLoading(show = true) {
            let loader = document.querySelector('.loading-indicator');
            if (!loader && show) {
                loader = document.createElement('div');
                loader.className = 'loading-indicator';
                loader.innerHTML = `
                <div class="loading-spinner"></div>
                <div class="loading-text">åŠ è½½ä¸­...</div>
            `;
                document.body.appendChild(loader);
            } else if (loader && !show) {
                loader.remove();
            }
        }

        // æ·»åŠ ç›¸åº”çš„CSSæ ·å¼
        const style = document.createElement('style');
        style.textContent = `
        .loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 10px;
            color: #333;
        }
        
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
            `;
            // åœ¨æ–‡æ¡£åŠ è½½å®Œæˆååˆå§‹åŒ–æ—¥æœŸæ—¶é—´é€‰æ‹©å™¨
            document.addEventListener('DOMContentLoaded', function () {
                // åˆå§‹åŒ–æ—¥æœŸæ—¶é—´é€‰æ‹©å™¨
                const preferredTimeInput=document.getElementById('preferredTime');
                if (preferredTimeInput) {
                    initDateTimePicker(preferredTimeInput);
                }
            }
            );
            // åœ¨å·²æœ‰çš„ DOMContentLoaded äº‹ä»¶ç›‘å¬å™¨ä¸­æ·»åŠ æ ·å¼æ³¨å…¥ä»£ç 
            document.addEventListener('DOMContentLoaded', function () {
                // æ³¨å…¥æ—¥æœŸæ—¶é—´é€‰æ‹©å™¨æ ·å¼
                const pickerStyles=` .datetime-picker {
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 2000;
                }
                .datetime-picker.active {
                    display: block;
                }
                // ... å…¶ä½™æ ·å¼ä¿æŒä¸å˜ ...
                `;
                // åˆ›å»ºå¹¶æ·»åŠ æ ·å¼åˆ°æ–‡æ¡£å¤´éƒ¨
                const styleElement=document.createElement('style');
                styleElement.textContent=pickerStyles;
                document.head.appendChild(styleElement);
                // å…¶ä½™ç°æœ‰çš„åˆå§‹åŒ–ä»£ç ...
                const scheduleManagementButton=document.getElementById('schedule-management');
                if (scheduleManagementButton) {
                    // ... ç°æœ‰çš„æ—¥ç¨‹ç®¡ç†ä»£ç  ...
                }
                // ... å…¶ä»–ç°æœ‰çš„åˆå§‹åŒ–ä»£ç  ...
            }
            );
            // ä¿ç•™ä¸€ä¸ªç»Ÿä¸€çš„åˆå§‹åŒ–å‡½æ•°
            document.addEventListener('DOMContentLoaded', function () {
                // åˆå§‹åŒ–ç½‘ç»œæ£€æµ‹
                initNetworkDetection();
                // åˆå§‹åŒ–æ—¥æœŸæ—¶é—´é€‰æ‹©å™¨
                const preferredTimeInput=document.getElementById('preferredTime');
                if (preferredTimeInput) {
                    initDateTimePicker(preferredTimeInput);
                }
                // åˆå§‹åŒ–æ—¥ç¨‹ç®¡ç†
                const scheduleManagementButton=document.getElementById('schedule-management');
                if (scheduleManagementButton) {
                    // æ—¥ç¨‹ç®¡ç†ç›¸å…³ä»£ç 
                }
                // åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
                updateGreeting();
                displayUsername();
                // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡é—®å€™è¯­
                setInterval(updateGreeting, 60000);
            }
            );
            // è·å–å¹¶æ˜¾ç¤ºç”¨æˆ·å
            function displayUsername() {
                const usernameDisplay=document.getElementById('username-display');
                if (!usernameDisplay) return;
                $.ajax( {
                    url: API_URLS.GET_USER_INFO, method: 'GET', xhrFields: {
                        withCredentials: true
                    }
                    , success: function (data) {
                        if (data.message==='Success') {
                            const username=data.username;
                            utils.saveData('username', username);
                            usernameDisplay.textContent=username;
                        }
                        else {
                            handleSessionError(data.message);
                        }
                    }
                    , error: function (xhr, status, error) {
                        console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                        const username=utils.getData('username');
                        usernameDisplay.textContent=username || 'ç”¨æˆ·';
                    }
                }
                );
            }
            // é‡ç½®è§¦æ‘¸çŠ¶æ€çš„å‡½æ•°
            function resetTouchState() {
                startY=0;
                currentY=0;
                pickerContent.style.transform='';
            }
            // ä¿®æ”¹è·å–å†å²è®¢å•çš„å‡½æ•°
            function fetchHistoryOrders() {
                $.ajax( {
                    url: API_URLS.GET_HISTORY, method: 'GET', xhrFields: {
                        withCredentials: true
                    }
                    , success: function (data) {
                        if (data.message==='Success') {
                            displayHistoryOrders(data.report_info);
                        }
                        else if (data.message==='No history report') {
                            showNoOrders();
                        }
                        else {
                            handleSessionError(data.message);
                        }
                    }
                    , error: function (xhr, status, error) {
                        console.error('è·å–å†å²è®¢å•å¤±è´¥:', error);
                        showError();
                    }
                }
                );
            }
            // ä¿®æ”¹æ—¥æœŸé€‰æ‹©å™¨çš„ç›¸å…³ JavaScript ä»£ç 
            function initDateTimePicker() {
                const picker=document.querySelector('.datetime-picker');
                const container=picker.querySelector('.picker-container');
                const cancelBtn=picker.querySelector('.picker-cancel');
                // ç‚¹å‡»é®ç½©å±‚å…³é—­
                picker.addEventListener('click', (e)=> {
                    if (e.target===picker) {
                        closeDateTimePicker();
                    }
                }
                );
                // é˜»æ­¢å®¹å™¨çš„ç‚¹å‡»äº‹ä»¶å†’æ³¡
                container.addEventListener('click', (e)=> {
                    e.stopPropagation();
                }
                );
                // å–æ¶ˆæŒ‰é’®å…³é—­
                cancelBtn.addEventListener('click', ()=> {
                    closeDateTimePicker();
                }
                );
            }
            function closeDateTimePicker() {
                const picker=document.querySelector('.datetime-picker');
                const container=picker.querySelector('.picker-container');
                // å…ˆæ‰§è¡ŒåŠ¨ç”»
                container.style.transform='translateY(100%)';
                // ç­‰å¾…åŠ¨ç”»å®Œæˆåéšè—æ•´ä¸ªé€‰æ‹©å™¨
                setTimeout(()=> {
                    picker.classList.remove('active');
                    container.style.transform=''; // é‡ç½®transform
                }
                , 300); // ä¸ CSS transition æ—¶é—´ç›¸åŒ¹é…
            }
            function showDateTimePicker() {
                const picker=document.querySelector('.datetime-picker');
                picker.classList.add('active');
                // ç¡®ä¿å®¹å™¨åŠ¨ç”»æ­£ç¡®æ˜¾ç¤º
                const container=picker.querySelector('.picker-container');
                // å¼ºåˆ¶é‡æ’åæ‰§è¡ŒåŠ¨ç”»
                requestAnimationFrame(()=> {
                    container.style.transform='translateY(0)';
                }
                );
            }
            // ç¡®ä¿åœ¨é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
            document.addEventListener('DOMContentLoaded', ()=> {
                initDateTimePicker();
            }
            );
            // ç»Ÿä¸€çš„åˆå§‹åŒ–å‡½æ•°
            document.addEventListener('DOMContentLoaded', function () {
                // åˆå§‹åŒ–ç½‘ç»œæ£€æµ‹
                initNetworkDetection();
                // åˆå§‹åŒ–æ—¥æœŸæ—¶é—´é€‰æ‹©å™¨
                const preferredTimeInput=document.getElementById('preferredTime');
                if (preferredTimeInput) {
                    initDateTimePicker(preferredTimeInput);
                }
                // åˆå§‹åŒ–æ—¥ç¨‹ç®¡ç†
                initScheduleManagement();
                // åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
                updateGreeting();
                displayUsername();
                // è·å–å¤©æ°”ä¿¡æ¯
                fetchWeatherAndLocation();
                // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡é—®å€™è¯­
                setInterval(updateGreeting, 60000);
            }
            );
            // æ›´æ–°é—®å€™è¯­å‡½æ•° - åˆå¹¶åçš„ç‰ˆæœ¬
            function updateGreeting() {
                const greetingText=document.getElementById('greetingText');
                if (!greetingText) return;
                const hour=new Date().getHours();
                let greeting='';
                if (hour >=5 && hour < 9) {
                    greeting='æ—©ä¸Šå¥½';
                }
                else if (hour >=9 && hour < 11) {
                    greeting='ä¸Šåˆå¥½';
                }
                else if (hour >=11 && hour < 13) {
                    greeting='ä¸­åˆå¥½';
                }
                else if (hour >=13 && hour < 18) {
                    greeting='ä¸‹åˆå¥½';
                }
                else {
                    greeting='æ™šä¸Šå¥½';
                }
                greetingText.textContent=greeting;
            }
            // æ˜¾ç¤ºç”¨æˆ·åå‡½æ•° - åˆå¹¶åçš„ç‰ˆæœ¬
            function displayUsername() {
                const usernameDisplay=document.getElementById('username-display');
                if (!usernameDisplay) return;
                $.ajax( {
                    url: API_URLS.GET_USER_INFO, method: 'GET', xhrFields: {
                        withCredentials: true
                    }
                    , success: function (data) {
                        if (data.message==='Success') {
                            const username=data.username;
                            utils.saveData('username', username);
                            usernameDisplay.textContent=username;
                        }
                        else {
                            handleSessionError(data.message);
                        }
                    }
                    , error: function (xhr, status, error) {
                        console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                        const username=utils.getData('username');
                        usernameDisplay.textContent=username || 'ç”¨æˆ·';
                    }
                }
                );
            }
            // æ—¥ç¨‹ç®¡ç†åˆå§‹åŒ–å‡½æ•° - æŠ½å–ä¸ºç‹¬ç«‹å‡½æ•°
            function initScheduleManagement() {
                const scheduleManagementButton=document.getElementById('schedule-management');
                if (!scheduleManagementButton) return;
                scheduleManagementButton.addEventListener('click', function () {
                    const modal=document.getElementById('scheduleModal');
                    modal.style.display="block";
                    document.getElementById('overlay').style.display="block";
                    this.classList.add('active');
                    toggleBodyScroll(true);
                    // åˆå§‹åŒ–æ—¥å†
                    initCalendar();
                }
                );
            }
            // æ—¥å†åˆå§‹åŒ–å‡½æ•° - æŠ½å–ä¸ºç‹¬ç«‹å‡½æ•°
            function initCalendar() {
                const calendarEl=document.getElementById('mobileCalendar');
                if (!calendarEl) return;
                const calendar=new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth', // é»˜è®¤æœˆè§†å›¾
                    locale: 'zh-cn', height: 'auto', headerToolbar: {
                        left: 'prev,next', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    }
                    , // é’ˆå¯¹ç§»åŠ¨ç«¯çš„è§†å›¾é…ç½®
                    views: {
                        dayGridMonth: {
                            titleFormat: {
                                year: 'numeric', month: 'short'
                            }
                            , // ç®€åŒ–æ ‡é¢˜æ˜¾ç¤º
                            dayHeaderFormat: {
                                weekday: 'narrow'
                            } // ä½¿ç”¨å•å­—ç¬¦è¡¨ç¤ºæ˜ŸæœŸ
                        }
                        , timeGridWeek: {
                            slotMinTime: '18:00:00', slotMaxTime: '21:00:00', slotDuration: '00:30:00', allDaySlot: false, dayHeaderFormat: {
                                weekday: 'narrow', day: 'numeric'
                            }
                            , // ç®€åŒ–å¤´éƒ¨æ˜¾ç¤º
                            slotLabelFormat: {
                                hour: '2-digit', minute: '2-digit', hour12: false
                            }
                        }
                        , timeGridDay: {
                            slotMinTime: '18:00:00', slotMaxTime: '21:00:00', slotDuration: '00:30:00', allDaySlot: false, slotLabelFormat: {
                                hour: '2-digit', minute: '2-digit', hour12: false
                            }
                        }
                    }
                    , // ç§»åŠ¨ç«¯è§¦æ‘¸æ”¯æŒ
                    eventClick: function (info) {
                        const order=info.event.extendedProps;
                        showOrderDetail(order);
                    }
                    , // ç§»åŠ¨ç«¯æ‰‹åŠ¿æ”¯æŒ
                    editable: false, // ç¦ç”¨æ‹–åŠ¨ä»¥é¿å…ä¸æ»‘åŠ¨å†²çª
                    eventDragStart: function () {
                        return false;
                    }
                    , // ç¦ç”¨æ‹–åŠ¨
                    events: function (fetchInfo, successCallback, failureCallback) {
                        $.ajax( {
                            url: API_URLS.GET_HISTORY, method: 'GET', xhrFields: {
                                withCredentials: true
                            }
                            , success: function (response) {
                                if (response.message==='Success') {
                                    const events=response.report_info.map(order=> ( {
                                        title: `$ {
                                            order.issue.substring(0, 8)
                                        }
                                        ...`, // ç§»åŠ¨ç«¯æ˜¾ç¤ºæ›´çŸ­çš„æ ‡é¢˜
                                        start: new Date(order.date.replace(/-/g, '/')), extendedProps: order, backgroundColor: order.status==='allocated' ? '#2ecc71': '#f1c40f', borderColor: order.status==='allocated' ? '#27ae60': '#f39c12', textColor: order.status==='allocated' ? '#fff': '#000', allDay: false, displayEventTime: true, eventDisplay: 'block'
                                    }
                                    ));
                                    successCallback(events);
                                }
                                else if (response.message==='No history report') {
                                    successCallback([]);
                                }
                                else {
                                    handleSessionError(response.message);
                                    failureCallback(new Error(response.message));
                                }
                            }
                            , error: function (xhr, status, error) {
                                console.error('è·å–å†å²è®¢å•å¤±è´¥:', error);
                                failureCallback(new Error(error));
                            }
                        }
                        );
                    }
                    , // ç§»åŠ¨ç«¯ä¼˜åŒ–çš„äº‹ä»¶æ¸²æŸ“
                    eventDidMount: function (info) {
                        // ä½¿ç”¨ç§»åŠ¨ç«¯å‹å¥½çš„è§¦æ‘¸æç¤º
                        info.el.addEventListener('click', function () {
                            showOrderDetail(info.event.extendedProps);
                        }
                        );
                    }
                    , // ç§»åŠ¨ç«¯å‹å¥½çš„æ—¶é—´æ ¼å¼
                    eventTimeFormat: {
                        hour: '2-digit', minute: '2-digit', hour12: false
                    }
                    , // ç§»åŠ¨ç«¯ç‰¹å®šé…ç½®
                    dayMaxEvents: 2, // é™åˆ¶æ¯å¤©æ˜¾ç¤ºçš„äº‹ä»¶æ•°é‡
                    moreLinkContent: function (args) {
                        return '+' + args.num; // ç®€åŒ–"æ›´å¤š"é“¾æ¥çš„æ˜¾ç¤º
                    }
                    , slotEventOverlap: false, nowIndicator: true, scrollTime: '18:00:00'
                }
                );
                // æ·»åŠ ç§»åŠ¨ç«¯æ‰‹åŠ¿æ”¯æŒ
                let touchStartX=0;
                calendarEl.addEventListener('touchstart', function (e) {
                    touchStartX=e.touches[0].clientX;
                }
                );
                calendarEl.addEventListener('touchend', function (e) {
                    const touchEndX=e.changedTouches[0].clientX;
                    const diff=touchStartX - touchEndX;
                    if (Math.abs(diff) > 50) {
                        // æœ€å°æ»‘åŠ¨è·ç¦»
                        if (diff > 0) {
                            calendar.next();
                        }
                        else {
                            calendar.prev();
                        }
                    }
                }
                );
                calendar.render();
                // æ·»åŠ å“åº”å¼å¤„ç†
                function handleResize() {
                    const width=window.innerWidth;
                    if (width < 768) {
                        calendar.setOption('headerToolbar', {
                            left: 'prev,next', center: 'title', right: 'dayGridMonth,timeGridDay' // åœ¨å°å±å¹•ä¸Šåªæ˜¾ç¤ºæœˆè§†å›¾å’Œæ—¥è§†å›¾
                        }
                        );
                    }
                    else {
                        calendar.setOption('headerToolbar', {
                            left: 'prev,next', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay'
                        }
                        );
                    }
                }
                // åˆå§‹åŒ–æ—¶å’Œçª—å£å¤§å°æ”¹å˜æ—¶è°ƒç”¨
                handleResize();
                window.addEventListener('resize', handleResize);
            }
            // æ·»åŠ ç§»åŠ¨ç«¯å‹å¥½çš„è®¢å•è¯¦æƒ…æ˜¾ç¤ºå‡½æ•°
            function showOrderDetail(order) {
                const detailCard=document.getElementById('orderDetailCard');
                const detailContent=document.getElementById('orderDetailContent');
                const overlay=document.getElementById('detailOverlay');
                try {
                    const formattedDate=formatDate(order.date);
                    const formattedCallDate=formatDate(order.call_date);
                    // æ ¹æ®çŠ¶æ€è·å–å¯¹åº”çš„æ ·å¼ç±»å’Œæ–‡æœ¬
                    let statusClass,
                    statusText;
                    switch (order.status) {
                        case '0': statusClass='status-pending';
                        statusText='å¾…åˆ†é…';
                        break;
                        case '1': statusClass='status-allocated';
                        statusText='å·²åˆ†é…';
                        break;
                        case '2': statusClass='status-completed';
                        statusText='å·²å®Œæˆ';
                        break;
                        case '3': statusClass='status-cancelled';
                        statusText='å·²æ’¤å•';
                        break;
                        default: statusClass='status-unknown';
                        statusText='æœªçŸ¥çŠ¶æ€';
                    }
                    detailContent.innerHTML=` <div class="detail-row"><span class="detail-label">çŠ¶æ€</span><span class="detail-value"><span class="status-badge ${statusClass}">$ {
                        statusText
                    }
                    </span></span></div><div class="detail-row"><span class="detail-label">è”ç³»ç”µè¯</span><span class="detail-value">$ {
                        order.userPhoneNumber
                    }
                    </span></div><div class="detail-row"><span class="detail-label">æœåŠ¡åœ°å€</span><span class="detail-value">$ {
                        order.address
                    }
                    </span></div><div class="detail-row"><span class="detail-label">é—®é¢˜æè¿°</span><span class="detail-value">$ {
                        order.issue
                    }
                    </span></div><div class="detail-row"><span class="detail-label">æŠ¥å•æ—¶é—´</span><span class="detail-value">$ {
                        formattedCallDate
                    }
                    </span></div><div class="detail-row"><span class="detail-label">é¢„çº¦æ—¶é—´</span><span class="detail-value">$ {
                        formattedDate
                    }
                    </span></div>`;
                    detailCard.classList.add('show');
                    overlay.classList.add('show');
                }
                catch (error) {
                    console.error('æ˜¾ç¤ºè®¢å•è¯¦æƒ…æ—¶å‡ºé”™:', error);
                    showMessage('åŠ è½½è®¢å•è¯¦æƒ…å¤±è´¥');
                }
            }
            // æ·»åŠ è·å–çŠ¶æ€æ–‡æœ¬çš„è¾…åŠ©å‡½æ•°
            function getStatusText(status) {
                switch (status) {
                    case '0': return 'å¾…åˆ†é…';
                    case '1': return 'å·²åˆ†é…';
                    case '2': return 'å·²å®Œæˆ';
                    case '3': return 'å·²æ’¤å•';
                    default: return 'æœªçŸ¥çŠ¶æ€';
                }
            }
            // ä¿®æ”¹è®¢å•çŠ¶æ€å˜åŒ–çš„å¤„ç†å‡½æ•°ï¼ˆåœ¨è®¢å•å®Œæˆæ—¶ï¼‰
            function completeOrder(orderId) {
                $.ajax( {
                    url: API_URLS.COMPLETE_REPORT, method: 'POST', data: JSON.stringify( {
                        report_id: orderId
                    }
                    ), contentType: 'application/json', xhrFields: {
                        withCredentials: true
                    }
                }
                ).then(response=> {
                    if (response.message==='Success') {
                        showMessage('è®¢å•å·²å®Œæˆ');
                        updateCalendarEvent(orderId, 'completed'); // æ›´æ–°æ—¥å†æ˜¾ç¤º
                        fetchHistoryOrders(); // åˆ·æ–°è®¢å•åˆ—è¡¨
                    }
                    else {
                        handleSessionError(response.message);
                    }
                }
                ).catch(error=> {
                    console.error('å®Œæˆè®¢å•å¤±è´¥:', error);
                    showMessage('å®Œæˆè®¢å•å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
                );
            }
            // ä¿®æ”¹è®¢å•çŠ¶æ€å˜åŒ–çš„å¤„ç†å‡½æ•°ï¼ˆåœ¨è®¢å•æ’¤é”€æ—¶ï¼‰
            function cancelOrder(orderId) {
                $.ajax( {
                    url: API_URLS.CANCEL_REPORT, method: 'POST', data: JSON.stringify( {
                        report_id: orderId
                    }
                    ), contentType: 'application/json', xhrFields: {
                        withCredentials: true
                    }
                }
                ).then(response=> {
                    if (response.message==='Success') {
                        showMessage('è®¢å•å·²æ’¤é”€');
                        updateCalendarEvent(orderId, 'cancelled'); // æ›´æ–°æ—¥å†æ˜¾ç¤º
                        fetchHistoryOrders(); // åˆ·æ–°è®¢å•åˆ—è¡¨
                    }
                    else {
                        handleSessionError(response.message);
                    }
                }
                ).catch(error=> {
                    console.error('æ’¤é”€è®¢å•å¤±è´¥:', error);
                    showMessage('æ’¤é”€è®¢å•å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
                );
            }
            var calendar=new FullCalendar.Calendar(document.getElementById('mobileCalendar'), {
                // åŸºç¡€é…ç½®
                locale: 'zh-cn', // è®¾ç½®ä¸ºä¸­æ–‡
                initialView: 'dayGridMonth', height: 'auto', // å·¥å…·æ é…ç½®
                headerToolbar: {
                    left: 'prev,next', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay'
                }
                , // æŒ‰é’®æ–‡å­—æœ¬åœ°åŒ–
                buttonText: {
                    today: 'ä»Šå¤©', month: 'æœˆ', week: 'å‘¨', day: 'æ—¥'
                }
                , // ä¿®æ”¹æ ‡é¢˜æ ¼å¼åŒ–é…ç½®
                titleFormat: {
                    year: 'numeric', month: 'long'
                }
                , // åˆ—å¤´æ ¼å¼åŒ–
                dayHeaderFormat: {
                    weekday: 'short' // æ˜¾ç¤ºä¸ºï¼šå‘¨æ—¥ã€å‘¨ä¸€ç­‰
                }
                , // æ—¥æœŸå•å…ƒæ ¼æ ¼å¼åŒ–
                dayCellContent: function(info) {
                    return info.date.getDate();
                }
                , // æ›´å¤šäº‹ä»¶æ˜¾ç¤ºæ–‡æœ¬
                moreLinkText: 'æ›´å¤š', noEventsText: 'æš‚æ— äº‹ä»¶', // ... å…¶ä»–ç°æœ‰é…ç½®ä¿æŒä¸å˜ ...
            }
            );
            // ... rest of the code ...
            // æ·»åŠ è·å–çŠ¶æ€æ ·å¼ç±»çš„è¾…åŠ©å‡½æ•°
            function getStatusClass(status) {
                switch (status) {
                    case '0': return 'status-pending';
                    case '1': return 'status-allocated';
                    case '2': return 'status-completed';
                    case '3': return 'status-cancelled';
                    default: return 'status-unknown';
                }
            }
            // æ§åˆ¶bodyæ»šåŠ¨çš„å‡½æ•°
            function toggleBodyScroll(disable) {
                if (disable) {
                    document.body.classList.add('modal-open');
                }
                else {
                    document.body.classList.remove('modal-open');
                }
            }
            // æ˜¾ç¤ºé®ç½©å±‚
            function showOverlay() {
                document.getElementById('overlay').style.display='block';
            }
            // éšè—é®ç½©å±‚
            function hideOverlay() {
                document.getElementById('overlay').style.display='none';
            }
            // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
            function showMessage(message) {
                const messageModal=document.getElementById('messageModal');
                const messageText=document.getElementById('messageText');
                messageText.textContent=message;
                messageModal.style.display='block';
                toggleBodyScroll(true);
            }
            // å…³é—­æ¶ˆæ¯æç¤º
            function closeMessage() {
                const messageModal=document.getElementById('messageModal');
                messageModal.classList.remove('show');
                setTimeout(()=> {
                    messageModal.style.display='none';
                }
                , 300);
                toggleBodyScroll(false);
            }
            // å…³é—­è®¢å•è¯¦æƒ…
            function closeDetail() {
                const detailCard=document.getElementById('orderDetailCard');
                const overlay=document.getElementById('detailOverlay');
                detailCard.classList.remove('show');
                overlay.classList.remove('show');
                detailCard.style.transform='';
                toggleBodyScroll(false);
            }
            // æ˜¾ç¤ºè®¢å•è¯¦æƒ…
            function showOrderDetail(order) {
                const detailCard=document.getElementById('orderDetailCard');
                const detailContent=document.getElementById('orderDetailContent');
                const overlay=document.getElementById('detailOverlay');
                // è®¾ç½®è¯¦æƒ…å†…å®¹
                detailContent.innerHTML=` <div class="detail-row"><span class="detail-label">çŠ¶æ€</span><span class="detail-value"><span class="status-badge ${getStatusClass(order.status)}">$ {
                    getStatusText(order.status)
                }
                </span></span></div><div class="detail-row"><span class="detail-label">é—®é¢˜æè¿°</span><span class="detail-value">$ {
                    order.issue
                }
                </span></div><div class="detail-row"><span class="detail-label">é¢„çº¦æ—¶é—´</span><span class="detail-value">$ {
                    formatDate(order.date)
                }
                </span></div><div class="detail-row"><span class="detail-label">åœ°å€</span><span class="detail-value">$ {
                    order.address
                }
                </span></div><div class="detail-row"><span class="detail-label">è”ç³»ç”µè¯</span><span class="detail-value">$ {
                    order.userPhoneNumber
                }
                </span></div>`;
                overlay.style.display='block';
                detailCard.style.display='block';
                // ä½¿ç”¨ setTimeout ç¡®ä¿è¿‡æ¸¡æ•ˆæœæ­£å¸¸æ˜¾ç¤º
                setTimeout(()=> {
                    overlay.classList.add('show');
                    detailCard.classList.add('show');
                }
                , 10);
                toggleBodyScroll(true);
            }
            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
            document.addEventListener('DOMContentLoaded', function() {
                // æ¨¡æ€æ¡†å…³é—­æŒ‰é’®äº‹ä»¶
                document.querySelectorAll('.close-button').forEach(button=> {
                    button.addEventListener('click', function() {
                        const modal=this.closest('.modal');
                        hideModal(modal.id);
                    }
                    );
                }
                );
                // æ¶ˆæ¯ç¡®è®¤æŒ‰é’®äº‹ä»¶
                document.getElementById('messageConfirm').addEventListener('click', closeMessage);
                // å…³é—­è¯¦æƒ…æŒ‰é’®äº‹ä»¶
                document.getElementById('closeDetail').addEventListener('click', closeDetail);
                // è¯¦æƒ…é®ç½©å±‚ç‚¹å‡»äº‹ä»¶
                document.getElementById('detailOverlay').addEventListener('click', closeDetail);
                // ä¿®æ”¹ä¿¡æ¯ç®¡ç†é“¾æ¥çš„ç‚¹å‡»äº‹ä»¶
                document.getElementById('info-link').addEventListener('click', function(event) {
                    event.preventDefault();
                    showModal('editModal');
                }
                );
                // è®¢å•ç®¡ç†ç‚¹å‡»äº‹ä»¶
                document.getElementById('order-management').addEventListener('click', function() {
                    showModal('orderManagementModal');
                    this.classList.add('active');
                }
                );
                // æ—¥ç¨‹ç®¡ç†ç‚¹å‡»äº‹ä»¶
                document.getElementById('schedule-management').addEventListener('click', function() {
                    showModal('scheduleModal');
                    this.classList.add('active');
                }
                );
                // é€€å‡ºç¡®è®¤ç‚¹å‡»äº‹ä»¶
                document.getElementById('logout').addEventListener('click', function(event) {
                    event.preventDefault();
                    showModal('logoutModal');
                }
                );
            }
            );
            // è·å–çŠ¶æ€æ ·å¼ç±»
            function getStatusClass(status) {
                switch (status) {
                    case '0': return 'status-pending';
                    case '1': return 'status-allocated';
                    case '2': return 'status-completed';
                    case '3': return 'status-cancelled';
                    default: return 'status-unknown';
                }
            }
            // è·å–çŠ¶æ€æ–‡æœ¬
            function getStatusText(status) {
                switch (status) {
                    case '0': return 'å¾…åˆ†é…';
                    case '1': return 'å·²åˆ†é…';
                    case '2': return 'å·²å®Œæˆ';
                    case '3': return 'å·²æ’¤å•';
                    default: return 'æœªçŸ¥çŠ¶æ€';
                }
            }
            // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
            function showLoading(show) {
                const loadingIndicator=document.querySelector('.loading-indicator');
                if (!loadingIndicator) return;
                loadingIndicator.style.display=show ? 'flex': 'none';
                toggleBodyScroll(show);
            }
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            function showModal(modalId) {
                const modal=document.getElementById(modalId);
                const overlay=document.getElementById('overlay');
                modal.style.display='block';
                overlay.style.display='block';
                // ä½¿ç”¨ setTimeout ç¡®ä¿è¿‡æ¸¡æ•ˆæœæ­£å¸¸æ˜¾ç¤º
                setTimeout(()=> {
                    modal.classList.add('show');
                    overlay.classList.add('show');
                }
                , 10);
                toggleBodyScroll(true);
            }
            // éšè—æ¨¡æ€æ¡†
            function hideModal(modalId) {
                const modal=document.getElementById(modalId);
                const overlay=document.getElementById('overlay');
                modal.classList.remove('show');
                overlay.classList.remove('show');
                // ç­‰å¾…è¿‡æ¸¡æ•ˆæœå®Œæˆåéšè—å…ƒç´ 
                setTimeout(()=> {
                    modal.style.display='none';
                    overlay.style.display='none';
                }
                , 300);
                toggleBodyScroll(false);
            }
    </script>
</body>

</html>